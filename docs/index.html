<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>LearnPlasma</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Vollkorn:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg: #ffffff;
      --bg-light: #f5f5f3;
      --border: #e0e0dc;
      --text: #1a1a1a;
      --muted: #8a8a82;
      --green: #3d5a47;
      --green-light: #e8f0eb;
      --green-dark: #2f4636;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    .app { width: 100%; min-height: 100vh; position: relative; }

    /* ===== SCREENS ===== */
    .screen { display: none; flex-direction: column; min-height: calc(100vh - 65px); }
    .screen.active { display: flex; }
    .screen-pad { padding: 2rem 4rem; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ===== LOGIN SCREEN ===== */
    .login-screen {
      min-height: 100vh;
      background: var(--green);
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    .login-box { width: 100%; max-width: 420px; }
    .login-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 3rem;
    }
    .plasma-logo { display: inline-block; overflow: visible; }
    .login-logo-text { font-size: 1.75rem; font-weight: 700; color: #fff; }
    .login-label { color: rgba(255,255,255,0.85); font-size: 0.9rem; font-weight: 500; margin-bottom: 0.5rem; }
    .login-input {
      width: 100%;
      padding: 0.9rem 1rem;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      color: #fff;
      font-size: 0.95rem;
      font-family: inherit;
      outline: none;
      margin-bottom: 1.25rem;
    }
    .login-input::placeholder { color: rgba(255,255,255,0.4); }
    .login-input:focus { border-color: rgba(255,255,255,0.5); }
    .login-btn {
      width: 100%;
      padding: 0.9rem;
      background: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      font-family: inherit;
      margin-top: 0.5rem;
      transition: opacity 0.15s;
    }
    .login-btn:hover { opacity: 0.9; }
    .login-footer { text-align: center; margin-top: 1.5rem; color: rgba(255,255,255,0.65); font-size: 0.9rem; }
    .login-footer a { color: #fff; text-decoration: underline; cursor: pointer; }

    /* ===== TOP BAR ===== */
    .topbar {
      display: flex;
      align-items: center;
      padding: 0.9rem 3rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .topbar-brand {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      cursor: pointer;
      flex-shrink: 0;
    }
    .topbar-brand-text { font-size: 1.3rem; font-weight: 700; color: var(--text); }
    .topbar-nav {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      margin-left: 2.5rem;
      flex: 1;
    }
    .topbar-nav button {
      background: none;
      border: none;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--muted);
      padding: 0.5rem 1.1rem;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .topbar-nav button:hover { color: var(--text); }
    .topbar-nav button.active {
      background: var(--green);
      color: #fff;
      font-weight: 600;
    }
    .topbar-profile {
      width: 40px; height: 40px;
      border-radius: 50%;
      background: var(--bg);
      border: 1.5px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      color: var(--muted);
    }
    .topbar-profile:hover { border-color: var(--green); color: var(--green); }

    /* ===== HOME ===== */
    .balance-hero {
      text-align: center;
      padding: 3rem 0 2.5rem;
    }
    .balance-label {
      color: var(--green);
      font-size: 0.95rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    .balance-amount {
      font-size: 3.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text);
    }
    .balance-currency {
      color: var(--muted);
      font-size: 0.95rem;
      margin-top: 0.25rem;
    }

    .home-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .home-section-header h2 { font-size: 1.2rem; font-weight: 700; }
    .view-all {
      color: var(--green);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: none;
      border: none;
      font-family: inherit;
    }
    .view-all:hover { text-decoration: underline; }

    /* Transaction items */
    .tx-card {
      border: 1.5px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      margin-bottom: 1.5rem;
    }
    .tx-item {
      display: flex;
      align-items: center;
      padding: 1rem 1.25rem;
    }
    .tx-item:not(:last-child) { border-bottom: 1px solid var(--border); }
    .tx-icon {
      width: 42px; height: 42px;
      border-radius: 50%;
      background: var(--green-light);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
      flex-shrink: 0;
      font-size: 1rem;
      color: var(--green);
    }
    .tx-info { flex: 1; }
    .tx-name { font-weight: 600; font-size: 0.95rem; }
    .tx-verified { color: var(--green); font-size: 0.8rem; font-weight: 500; display: flex; align-items: center; gap: 0.25rem; }
    .tx-amount { font-weight: 600; font-size: 0.95rem; text-align: right; }
    .tx-amount.outflow { color: #8b3a3a; }
    .tx-amount.inflow { color: var(--green); }
    .tx-date-label {
      color: var(--green);
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.75rem;
      margin-top: 0.5rem;
    }

    /* Action cards */
    .action-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 2rem;
    }
    .action-card {
      background: var(--green-dark);
      border-radius: 16px;
      padding: 1.5rem;
      color: #fff;
      cursor: pointer;
      transition: transform 0.15s, opacity 0.15s;
      border: none;
      font-family: inherit;
      text-align: left;
    }
    .action-card:hover { transform: scale(1.02); opacity: 0.9; }
    .action-card-icon { font-size: 1.3rem; margin-bottom: 0.75rem; }
    .action-card-label { font-size: 1.05rem; font-weight: 600; }

    /* ===== PAYMENTS / REQUESTS ===== */
    .page-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; }
    .payees-card {
      border: 1.5px solid var(--border);
      border-radius: 14px;
      padding: 1.5rem;
    }
    .payees-label {
      color: var(--green);
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 1rem;
    }
    .payee-group-letter {
      color: var(--green);
      font-size: 0.85rem;
      font-weight: 600;
      padding: 0.5rem 0 0.25rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0.5rem;
    }
    .payee-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 0;
      cursor: pointer;
      transition: opacity 0.1s;
    }
    .payee-item:hover { opacity: 0.7; }
    .payee-avatar {
      width: 44px; height: 44px;
      border-radius: 50%;
      background: var(--green-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.85rem;
      color: #fff;
      margin-right: 1rem;
      flex-shrink: 0;
    }
    .payee-name { font-weight: 500; font-size: 1rem; }

    .fab {
      position: fixed;
      bottom: 2rem;
      right: 3rem;
      width: 56px; height: 56px;
      border-radius: 50%;
      background: var(--green-dark);
      color: #fff;
      border: none;
      font-size: 1.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      transition: transform 0.15s;
    }
    .fab:hover { transform: scale(1.08); }

    /* ===== MODAL ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 200;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--bg);
      border-radius: 16px;
      padding: 2rem;
      width: 90%;
      max-width: 440px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    }
    .modal h2 { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
    .modal p { color: var(--muted); font-size: 0.9rem; margin-bottom: 1.5rem; }
    .modal-input {
      width: 100%;
      padding: 0.85rem 1rem;
      border: 1.5px solid var(--border);
      border-radius: 10px;
      font-size: 0.95rem;
      font-family: inherit;
      outline: none;
      margin-bottom: 1rem;
    }
    .modal-input:focus { border-color: var(--green); }
    .modal-input::placeholder { color: var(--muted); }
    .modal-buttons { display: flex; gap: 0.75rem; }
    .modal-buttons .btn { flex: 1; }
    .modal-result {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 10px;
      font-size: 0.9rem;
    }
    .modal-result.found { background: var(--green-light); color: var(--green); }
    .modal-result.not-found { background: #fef2f2; color: #dc2626; }

    /* ===== AMOUNT ===== */
    .amount-display {
      text-align: center;
      padding: 2.5rem 0 1.5rem;
    }
    .amount-to { color: var(--muted); font-size: 0.95rem; margin-bottom: 0.75rem; }
    .amount-to span { color: var(--text); font-weight: 600; }
    .amount-value {
      font-size: 3.5rem; font-weight: 700; letter-spacing: -0.02em;
    }
    .amount-value .currency { color: var(--muted); }
    .numpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      max-width: 400px;
      margin: 1rem auto;
    }
    .numpad button {
      padding: 1rem;
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 1.3rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
    }
    .numpad button:active { background: var(--border); }

    /* ===== PREVIEW ===== */
    .preview-card {
      background: var(--bg-light);
      border: 1.5px solid var(--border);
      border-radius: 16px;
      padding: 2rem 1.5rem;
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .preview-avatars { display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1.25rem; }
    .preview-avatar {
      width: 48px; height: 48px; border-radius: 50%; background: var(--green-dark);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 1rem; color: #fff;
    }
    .preview-arrow { color: var(--muted); font-size: 1.25rem; }
    .preview-amount { font-size: 2.25rem; font-weight: 700; }
    .preview-desc { color: var(--muted); font-size: 0.9rem; }
    .preview-fee {
      display: inline-block; background: var(--green-light); color: var(--green);
      padding: 0.35rem 0.9rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; margin-top: 0.75rem;
    }
    .preview-details { margin-bottom: 1.5rem; }
    .preview-row { display: flex; justify-content: space-between; padding: 0.6rem 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
    .preview-row:last-child { border-bottom: none; }
    .preview-row .label { color: var(--muted); }

    /* ===== RECEIPT ===== */
    .receipt-screen { align-items: center; justify-content: center; text-align: center; }
    .receipt-check {
      width: 72px; height: 72px; background: var(--green); border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #fff;
      margin-bottom: 1.25rem;
      animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
    .receipt-amount { font-size: 2.25rem; font-weight: 700; margin-bottom: 0.15rem; }
    .receipt-desc { color: var(--muted); font-size: 0.95rem; margin-bottom: 2.5rem; }
    .receipt-buttons { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 0.5rem; }

    /* ===== BUTTONS ===== */
    .btn {
      width: 100%; padding: 0.9rem; border: none; border-radius: 10px;
      font-size: 0.95rem; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.15s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--green); color: #fff; }
    .btn-primary:hover { background: var(--green-dark); }
    .btn-outline { background: transparent; border: 1.5px solid var(--border); color: var(--text); }

    /* ===== ACCOUNT SIDEBAR ===== */
    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 200;
    }
    .sidebar-overlay.open { display: block; }
    .sidebar {
      position: fixed;
      top: 0; right: -380px;
      width: 380px;
      height: 100vh;
      background: var(--bg);
      z-index: 201;
      padding: 2rem;
      transition: right 0.3s ease;
      box-shadow: -4px 0 24px rgba(0,0,0,0.1);
    }
    .sidebar.open { right: 0; }
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .sidebar-header h2 { font-size: 1.3rem; font-weight: 700; }
    .sidebar-close {
      width: 36px; height: 36px;
      border-radius: 50%;
      background: var(--bg-light);
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
    }
    .sidebar-menu-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 0;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      font-family: inherit;
      text-align: left;
    }
    .sidebar-menu-item:hover { color: var(--green); }
    .sidebar-menu-icon {
      width: 24px;
      text-align: center;
      color: var(--muted);
      font-size: 1.1rem;
    }

    /* ===== BACK LINK ===== */
    .back-link {
      background: none; border: none; font-family: inherit;
      font-size: 0.95rem; color: var(--green); cursor: pointer; font-weight: 500; margin-right: 0.75rem;
    }
    .page-header { display: flex; align-items: center; margin-bottom: 1.5rem; }
    .page-header h2 { font-size: 1.25rem; font-weight: 700; }

    .spacer { flex: 1; }
    .empty-state { text-align: center; color: var(--muted); padding: 2rem 0; font-size: 0.9rem; }

    /* ===== REGISTER ===== */
    .register-screen {
      min-height: 100vh;
      background: var(--green);
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    .register-box { width: 100%; max-width: 420px; }
    .register-box h1 { color: #fff; font-size: 1.5rem; margin-bottom: 0.5rem; }
    .register-box .subtitle { color: rgba(255,255,255,0.65); font-size: 0.9rem; margin-bottom: 2rem; }

    /* ===== WALKTHROUGH ===== */
    .walkthrough-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 500;
    }
    .walkthrough-overlay.active { display: block; }
    .walkthrough-highlight {
      position: absolute;
      box-shadow: 0 0 0 4000px rgba(0,0,0,0.55);
      border-radius: 12px;
      z-index: 501;
      pointer-events: none;
    }
    .walkthrough-box {
      position: absolute;
      z-index: 502;
      background: #fff;
      border-radius: 14px;
      padding: 1.25rem 1.5rem;
      max-width: 340px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    .walkthrough-box h3 { font-size: 1rem; font-weight: 700; margin-bottom: 0.35rem; }
    .walkthrough-box p { font-size: 0.85rem; color: var(--muted); line-height: 1.5; margin-bottom: 1rem; }
    .walkthrough-box .wt-btns { display: flex; justify-content: space-between; align-items: center; }
    .walkthrough-box .wt-step { font-size: 0.75rem; color: var(--muted); }
    .walkthrough-box .wt-next {
      background: var(--green); color: #fff; border: none; padding: 0.5rem 1.1rem;
      border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; font-family: inherit;
    }
    .walkthrough-box .wt-skip {
      background: none; border: none; color: var(--muted); font-size: 0.8rem; cursor: pointer; font-family: inherit;
    }

    /* ===== TOOLTIPS ===== */
    .tip {
      position: relative;
      border-bottom: 1px dashed var(--green);
      cursor: help;
      color: var(--green);
      font-weight: 500;
    }
    .tip:hover::after {
      content: attr(data-tip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text);
      color: #fff;
      padding: 0.5rem 0.85rem;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 400;
      white-space: normal;
      width: max-content;
      max-width: 260px;
      z-index: 600;
      line-height: 1.4;
      margin-bottom: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* ===== GLOSSARY ===== */
    .glossary-item {
      padding: 1rem 0;
      border-bottom: 1px solid var(--border);
    }
    .glossary-term {
      font-weight: 700;
      font-size: 1rem;
      color: var(--green);
      margin-bottom: 0.25rem;
    }
    .glossary-def {
      font-size: 0.9rem;
      color: var(--muted);
      line-height: 1.5;
    }
    .glossary-letter {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--green);
      padding: 1rem 0 0.25rem;
      border-bottom: 2px solid var(--green);
      margin-bottom: 0.25rem;
    }

    /* ===== TOAST ===== */
    .toast {
      position: fixed;
      top: 1.5rem;
      left: 50%;
      display: none;
      background: var(--text);
      color: #fff;
      padding: 0.85rem 1.5rem;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 500;
      z-index: 300;
      transition: transform 0.3s ease;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .toast.toast-error { background: #dc2626; }
    .toast.toast-success { background: var(--green); }
    .toast.show { display: block; position: fixed; top: 1.5rem; left: 50%; transform: translateX(-50%); }

    /* ===== NAV BADGE ===== */
    .nav-badge-wrap { position: relative; display: inline-block; }
    .nav-badge {
      position: absolute;
      top: -6px; right: -8px;
      background: #dc2626;
      color: #fff;
      font-size: 0.65rem;
      font-weight: 700;
      min-width: 18px; height: 18px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    /* ===== PLASMA COACH CHAT ===== */
    .coach-fab {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 56px; height: 56px;
      border-radius: 50%;
      background: var(--green);
      color: #fff;
      border: none;
      font-size: 1.5rem;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(0,0,0,0.18);
      transition: transform 0.15s;
      z-index: 150;
    }
    .coach-fab:hover { transform: scale(1.08); }
    .coach-fab.visible { display: flex; }

    .coach-panel {
      position: fixed;
      bottom: 0;
      right: 2rem;
      width: 400px;
      height: 520px;
      background: var(--bg);
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 32px rgba(0,0,0,0.15);
      display: none;
      flex-direction: column;
      z-index: 160;
      overflow: hidden;
    }
    .coach-panel.open { display: flex; }

    .coach-header {
      background: var(--green-dark);
      color: #fff;
      padding: 0.85rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }
    .coach-header-title { font-weight: 700; font-size: 1rem; flex: 1; }
    .coach-header-icon { font-size: 1.1rem; }
    .coach-level-select {
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 6px;
      color: #fff;
      font-size: 0.75rem;
      font-family: inherit;
      padding: 0.25rem 0.4rem;
      outline: none;
      cursor: pointer;
    }
    .coach-level-select option { color: var(--text); background: var(--bg); }
    .coach-close {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.3rem;
      cursor: pointer;
      padding: 0 0.25rem;
      line-height: 1;
    }

    .coach-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .coach-msg {
      max-width: 85%;
      padding: 0.7rem 0.9rem;
      border-radius: 14px;
      font-size: 0.9rem;
      line-height: 1.5;
      word-wrap: break-word;
    }
    .coach-msg.assistant {
      align-self: flex-start;
      background: var(--bg-light);
      color: var(--text);
      border-bottom-left-radius: 4px;
    }
    .coach-msg.user {
      align-self: flex-end;
      background: var(--green);
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .coach-msg.contact {
      align-self: flex-start;
      background: #fef2f2;
      color: #8b3a3a;
      border-bottom-left-radius: 4px;
      font-size: 0.85rem;
    }

    .coach-typing {
      align-self: flex-start;
      display: none;
      gap: 4px;
      padding: 0.7rem 0.9rem;
      background: var(--bg-light);
      border-radius: 14px;
      border-bottom-left-radius: 4px;
    }
    .coach-typing.visible { display: flex; }
    .coach-typing-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--muted);
      animation: coachBounce 1.4s infinite ease-in-out;
    }
    .coach-typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .coach-typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes coachBounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-6px); }
    }

    .coach-input-bar {
      display: flex;
      align-items: center;
      padding: 0.6rem 0.75rem;
      border-top: 1px solid var(--border);
      gap: 0.5rem;
      flex-shrink: 0;
    }
    .coach-input {
      flex: 1;
      padding: 0.6rem 0.85rem;
      border: 1.5px solid var(--border);
      border-radius: 20px;
      font-size: 0.9rem;
      font-family: inherit;
      outline: none;
      background: var(--bg);
      color: var(--text);
    }
    .coach-input:focus { border-color: var(--green); }
    .coach-input::placeholder { color: var(--muted); }
    .coach-send {
      width: 36px; height: 36px;
      border-radius: 50%;
      background: var(--green);
      color: #fff;
      border: none;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: opacity 0.15s;
    }
    .coach-send:hover { opacity: 0.85; }
    .coach-send:disabled { opacity: 0.4; cursor: default; }

    @media (max-width: 480px) {
      .coach-panel {
        right: 0;
        width: 100%;
        height: 100%;
        border-radius: 0;
      }
      .coach-fab { bottom: 1.25rem; right: 1.25rem; }
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- ===== LOGIN ===== -->
    <div id="screenConnect" class="screen login-screen active">
      <div class="login-box">
        <div class="login-logo">
          <svg class="plasma-logo" width="52" height="52" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19.909 10.0542C19.909 10.1559 19.909 10.2575 19.9039 10.3592H15.0621V10.1372H10.4014C10.4014 10.0915 10.4014 10.0441 10.4014 10C10.4014 9.95595 10.4014 9.90681 10.4014 9.86276H15.0621V9.64249H19.9005C19.9056 9.77974 19.909 9.91698 19.909 10.0559V10.0542ZM10.3219 9.05625L14.8826 8.49204L14.9097 8.7123L19.7261 8.11759C19.6804 7.88038 19.6246 7.64487 19.5636 7.41444L14.8234 8.00068L14.8505 8.22094L10.2677 8.78685C10.288 8.87665 10.3066 8.96645 10.3219 9.05795V9.05456V9.05625ZM10.0831 8.17011L14.4425 7.07726L14.4966 7.29244L19.1218 6.13182C19.0269 5.90647 18.9237 5.68621 18.8153 5.46933L14.3257 6.59607L14.3798 6.81125L9.98496 7.91427C10.0205 7.99898 10.0544 8.08539 10.0865 8.17181L10.0831 8.17011ZM9.69716 7.33988L13.7721 5.79465L13.8499 6.00136L18.1619 4.36632C18.0213 4.1613 17.8757 3.96137 17.72 3.76652L13.5994 5.3287L13.6773 5.53541L9.55326 7.09929C9.60405 7.17723 9.65314 7.25686 9.69885 7.33819L9.69716 7.33988ZM9.16219 6.57235L12.7614 4.68824L12.863 4.88478L16.8431 2.80075C16.6602 2.62284 16.4689 2.45341 16.2742 2.28905L12.5345 4.24771L12.6361 4.44426L8.97597 6.36056C9.0403 6.43002 9.10294 6.49949 9.16388 6.57235H9.16219ZM8.29371 5.74382L11.5526 3.66317L11.6711 3.84954L15.2669 1.55202C15.0401 1.408 14.8098 1.27245 14.5711 1.14707L11.2885 3.24466L11.407 3.43104L8.05501 5.57269C8.13796 5.62691 8.21584 5.68621 8.2954 5.74551L8.29371 5.74382ZM7.52342 5.25923L10.2541 3.00915L10.3946 3.18028L13.4707 0.645544C13.21 0.545578 12.9408 0.455778 12.67 0.377838L9.94263 2.62623L10.0831 2.79736L7.25255 5.12877C7.34566 5.16943 7.43539 5.21349 7.52512 5.25923H7.52342ZM6.50427 4.86106L8.66108 2.70417L8.81514 2.86005L11.556 0.125381C11.2597 0.0762453 10.9584 0.0406642 10.652 0.0169434L8.31403 2.35344L8.46808 2.50932L6.18939 4.78651C6.29435 4.80854 6.39931 4.83226 6.50258 4.86106H6.50427ZM5.31244 4.67977L7.03247 2.58556L7.20346 2.72619L9.44152 0C9.10124 0.0152491 8.76604 0.0491359 8.43592 0.0982718L6.65156 2.26872L6.82255 2.40935L4.96031 4.67808C5.01279 4.67808 5.06528 4.67469 5.11776 4.67469C5.18378 4.67469 5.24981 4.67469 5.31414 4.67808L5.31244 4.67977ZM4.28144 4.74246L5.60702 2.68214L5.79155 2.80244L7.39307 0.311759C7.02739 0.406642 6.66849 0.523551 6.31974 0.657404L5.19225 2.41105L5.37678 2.53135L3.909 4.81362C4.03089 4.78482 4.15617 4.7594 4.28144 4.73907V4.74246ZM3.13532 5.06269L4.08845 3.26838L4.28144 3.37343L5.54268 0.999661C5.13807 1.1979 4.7487 1.42325 4.37625 1.67231L3.65167 3.03626L3.84636 3.14131L2.72394 5.25246C2.85599 5.18468 2.99312 5.12199 3.13363 5.06608L3.13532 5.06269ZM2.31425 5.48458L2.71886 4.32904L2.92709 4.40359L3.71431 2.15859C3.31478 2.47713 2.94064 2.82447 2.59189 3.20061L2.2533 4.16638L2.46153 4.24094L1.93164 5.75229C2.05523 5.6574 2.1822 5.5693 2.31425 5.48797V5.48458ZM1.30356 6.31142L1.48302 5.47103L1.69802 5.51677L2.05861 3.82582C1.6794 4.3104 1.34419 4.82887 1.05639 5.37784L1.21722 5.41342L0.888793 6.80447C1.01746 6.63165 1.15628 6.4673 1.30526 6.31142H1.30356ZM0.560363 7.29244V6.17926C0.292879 6.89088 0.101576 7.77533 0 8.64283C0.125278 8.16164 0.31658 7.70925 0.560363 7.29075V7.29244ZM0.00677176 11.3826C0.111734 12.123 0.296264 12.8363 0.553591 13.5158V12.694C0.31658 12.2891 0.130356 11.8485 0.00677176 11.3809V11.3826ZM0.920959 13.243L1.20707 14.5866L1.04624 14.6222C1.33234 15.1728 1.66924 15.6913 2.04846 16.1742L1.68786 14.4832L1.47286 14.529L1.29171 13.6784C1.15966 13.5395 1.03439 13.3938 0.919266 13.2413L0.920959 13.243ZM1.91979 14.2426L2.45307 15.7641L2.24484 15.8387L2.58343 16.8045C2.93048 17.1789 3.30631 17.528 3.70584 17.8465L2.91863 15.6015L2.7104 15.676L2.30409 14.5137C2.17204 14.429 2.04507 14.3409 1.91979 14.2477V14.2443V14.2426ZM2.71717 14.7458L3.84128 16.8638L3.64659 16.9688L4.37117 18.3328C4.74362 18.5818 5.13299 18.8072 5.53761 19.0054L4.27637 16.6317L4.08168 16.7367L3.12517 14.9373C2.98465 14.8814 2.84752 14.817 2.71378 14.7492L2.71717 14.7458ZM3.90053 15.183L5.37 17.4687L5.18547 17.589L6.31297 19.3426C6.66172 19.4764 7.01893 19.5934 7.3863 19.6882L5.78477 17.1976L5.60024 17.3179L4.27298 15.2558C4.1477 15.2355 4.02242 15.2101 3.89884 15.1813L3.90053 15.183ZM4.95016 15.3219L6.81239 17.5906L6.6414 17.7313L8.42576 19.9017C8.75588 19.9509 9.09278 19.9848 9.43137 20L7.19161 17.2721L7.02062 17.4127L5.30059 15.3185C5.23796 15.3219 5.17532 15.3219 5.11098 15.3219C5.05681 15.3219 4.99925 15.3219 4.94508 15.3185V15.3219H4.95016ZM6.186 15.2152L8.46301 17.4907L8.30895 17.6466L10.6469 19.9831C10.9533 19.9593 11.2547 19.9238 11.5509 19.8746L8.81175 17.1366L8.656 17.2941L6.50089 15.1389C6.39931 15.166 6.29266 15.1932 6.18769 15.2135L6.186 15.2152ZM7.24747 14.8746L10.0747 17.2043L9.93417 17.3755L12.6615 19.6239C12.9324 19.5459 13.2015 19.4561 13.4623 19.3561L10.3845 16.8214L10.244 16.9925L7.51665 14.7442C7.42693 14.7899 7.3372 14.834 7.24409 14.8746H7.24747ZM8.04823 14.4307L11.3969 16.5707L11.2784 16.757L14.561 18.8546C14.7997 18.7292 15.0316 18.592 15.2568 18.4497L11.661 16.1522L11.5425 16.3385L8.28863 14.2596C8.20906 14.3189 8.1295 14.3765 8.04823 14.4324V14.4307ZM8.97089 13.6428L12.6259 15.5557L12.5244 15.7523L16.2641 17.7109C16.4605 17.5466 16.6501 17.3772 16.8329 17.1993L12.8528 15.1152L12.7512 15.3118L9.15711 13.431C9.09616 13.5039 9.03522 13.5751 8.96919 13.6428H8.97089ZM9.54987 12.9007L13.6671 14.4629L13.5892 14.6696L17.7098 16.2318C17.8639 16.0369 18.0112 15.837 18.1517 15.632L13.8398 13.997L13.7619 14.2037L9.69208 12.6601C9.64637 12.7414 9.59727 12.8211 9.54649 12.899L9.54987 12.9007ZM9.98157 12.0908L14.3697 13.1921L14.3155 13.4073L18.8052 14.5341C18.9169 14.3189 19.0185 14.0969 19.1133 13.8716L14.4882 12.7109L14.4357 12.9261L10.0831 11.8333C10.051 11.9197 10.0171 12.0061 9.98157 12.0908ZM10.266 11.2148L14.8403 11.7791L14.8132 11.9993L19.5535 12.5856C19.6161 12.3534 19.6703 12.1196 19.716 11.8824L14.8996 11.2877L14.8725 11.508L10.3185 10.9437C10.3032 11.0352 10.2846 11.125 10.2643 11.2148H10.266Z" fill="white"/></svg>
          <div class="login-logo-text">LearnPlasma</div>
        </div>
        <div style="text-align:center; margin-bottom:2.5rem;">
          <div style="color:rgba(255,255,255,0.85); font-size:1.1rem; font-weight:500; letter-spacing:0.02em;">Your entryway to the future of payments.</div>
        </div>
        <div>
          <button class="login-btn" id="connectBtn" onclick="connectWallet()" style="font-size:1.1rem; padding:1rem;">Start Learning</button>
          <div class="login-footer" style="margin-top:1rem"><a href="https://www.plasma.to/one" target="_blank" rel="noopener" style="color:var(--green)">Visit the real Plasma Pay &rarr;</a></div>
        </div>
      </div>
    </div>

    <!-- ===== REGISTER ===== -->
    <div id="screenRegister" class="screen register-screen">
      <div class="register-box">
        <div class="login-logo">
          <svg class="plasma-logo" width="52" height="52" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19.909 10.0542C19.909 10.1559 19.909 10.2575 19.9039 10.3592H15.0621V10.1372H10.4014C10.4014 10.0915 10.4014 10.0441 10.4014 10C10.4014 9.95595 10.4014 9.90681 10.4014 9.86276H15.0621V9.64249H19.9005C19.9056 9.77974 19.909 9.91698 19.909 10.0559V10.0542ZM10.3219 9.05625L14.8826 8.49204L14.9097 8.7123L19.7261 8.11759C19.6804 7.88038 19.6246 7.64487 19.5636 7.41444L14.8234 8.00068L14.8505 8.22094L10.2677 8.78685C10.288 8.87665 10.3066 8.96645 10.3219 9.05795V9.05456V9.05625ZM10.0831 8.17011L14.4425 7.07726L14.4966 7.29244L19.1218 6.13182C19.0269 5.90647 18.9237 5.68621 18.8153 5.46933L14.3257 6.59607L14.3798 6.81125L9.98496 7.91427C10.0205 7.99898 10.0544 8.08539 10.0865 8.17181L10.0831 8.17011ZM9.69716 7.33988L13.7721 5.79465L13.8499 6.00136L18.1619 4.36632C18.0213 4.1613 17.8757 3.96137 17.72 3.76652L13.5994 5.3287L13.6773 5.53541L9.55326 7.09929C9.60405 7.17723 9.65314 7.25686 9.69885 7.33819L9.69716 7.33988ZM9.16219 6.57235L12.7614 4.68824L12.863 4.88478L16.8431 2.80075C16.6602 2.62284 16.4689 2.45341 16.2742 2.28905L12.5345 4.24771L12.6361 4.44426L8.97597 6.36056C9.0403 6.43002 9.10294 6.49949 9.16388 6.57235H9.16219ZM8.29371 5.74382L11.5526 3.66317L11.6711 3.84954L15.2669 1.55202C15.0401 1.408 14.8098 1.27245 14.5711 1.14707L11.2885 3.24466L11.407 3.43104L8.05501 5.57269C8.13796 5.62691 8.21584 5.68621 8.2954 5.74551L8.29371 5.74382ZM7.52342 5.25923L10.2541 3.00915L10.3946 3.18028L13.4707 0.645544C13.21 0.545578 12.9408 0.455778 12.67 0.377838L9.94263 2.62623L10.0831 2.79736L7.25255 5.12877C7.34566 5.16943 7.43539 5.21349 7.52512 5.25923H7.52342ZM6.50427 4.86106L8.66108 2.70417L8.81514 2.86005L11.556 0.125381C11.2597 0.0762453 10.9584 0.0406642 10.652 0.0169434L8.31403 2.35344L8.46808 2.50932L6.18939 4.78651C6.29435 4.80854 6.39931 4.83226 6.50258 4.86106H6.50427ZM5.31244 4.67977L7.03247 2.58556L7.20346 2.72619L9.44152 0C9.10124 0.0152491 8.76604 0.0491359 8.43592 0.0982718L6.65156 2.26872L6.82255 2.40935L4.96031 4.67808C5.01279 4.67808 5.06528 4.67469 5.11776 4.67469C5.18378 4.67469 5.24981 4.67469 5.31414 4.67808L5.31244 4.67977ZM4.28144 4.74246L5.60702 2.68214L5.79155 2.80244L7.39307 0.311759C7.02739 0.406642 6.66849 0.523551 6.31974 0.657404L5.19225 2.41105L5.37678 2.53135L3.909 4.81362C4.03089 4.78482 4.15617 4.7594 4.28144 4.73907V4.74246ZM3.13532 5.06269L4.08845 3.26838L4.28144 3.37343L5.54268 0.999661C5.13807 1.1979 4.7487 1.42325 4.37625 1.67231L3.65167 3.03626L3.84636 3.14131L2.72394 5.25246C2.85599 5.18468 2.99312 5.12199 3.13363 5.06608L3.13532 5.06269ZM2.31425 5.48458L2.71886 4.32904L2.92709 4.40359L3.71431 2.15859C3.31478 2.47713 2.94064 2.82447 2.59189 3.20061L2.2533 4.16638L2.46153 4.24094L1.93164 5.75229C2.05523 5.6574 2.1822 5.5693 2.31425 5.48797V5.48458ZM1.30356 6.31142L1.48302 5.47103L1.69802 5.51677L2.05861 3.82582C1.6794 4.3104 1.34419 4.82887 1.05639 5.37784L1.21722 5.41342L0.888793 6.80447C1.01746 6.63165 1.15628 6.4673 1.30526 6.31142H1.30356ZM0.560363 7.29244V6.17926C0.292879 6.89088 0.101576 7.77533 0 8.64283C0.125278 8.16164 0.31658 7.70925 0.560363 7.29075V7.29244ZM0.00677176 11.3826C0.111734 12.123 0.296264 12.8363 0.553591 13.5158V12.694C0.31658 12.2891 0.130356 11.8485 0.00677176 11.3809V11.3826ZM0.920959 13.243L1.20707 14.5866L1.04624 14.6222C1.33234 15.1728 1.66924 15.6913 2.04846 16.1742L1.68786 14.4832L1.47286 14.529L1.29171 13.6784C1.15966 13.5395 1.03439 13.3938 0.919266 13.2413L0.920959 13.243ZM1.91979 14.2426L2.45307 15.7641L2.24484 15.8387L2.58343 16.8045C2.93048 17.1789 3.30631 17.528 3.70584 17.8465L2.91863 15.6015L2.7104 15.676L2.30409 14.5137C2.17204 14.429 2.04507 14.3409 1.91979 14.2477V14.2443V14.2426ZM2.71717 14.7458L3.84128 16.8638L3.64659 16.9688L4.37117 18.3328C4.74362 18.5818 5.13299 18.8072 5.53761 19.0054L4.27637 16.6317L4.08168 16.7367L3.12517 14.9373C2.98465 14.8814 2.84752 14.817 2.71378 14.7492L2.71717 14.7458ZM3.90053 15.183L5.37 17.4687L5.18547 17.589L6.31297 19.3426C6.66172 19.4764 7.01893 19.5934 7.3863 19.6882L5.78477 17.1976L5.60024 17.3179L4.27298 15.2558C4.1477 15.2355 4.02242 15.2101 3.89884 15.1813L3.90053 15.183ZM4.95016 15.3219L6.81239 17.5906L6.6414 17.7313L8.42576 19.9017C8.75588 19.9509 9.09278 19.9848 9.43137 20L7.19161 17.2721L7.02062 17.4127L5.30059 15.3185C5.23796 15.3219 5.17532 15.3219 5.11098 15.3219C5.05681 15.3219 4.99925 15.3219 4.94508 15.3185V15.3219H4.95016ZM6.186 15.2152L8.46301 17.4907L8.30895 17.6466L10.6469 19.9831C10.9533 19.9593 11.2547 19.9238 11.5509 19.8746L8.81175 17.1366L8.656 17.2941L6.50089 15.1389C6.39931 15.166 6.29266 15.1932 6.18769 15.2135L6.186 15.2152ZM7.24747 14.8746L10.0747 17.2043L9.93417 17.3755L12.6615 19.6239C12.9324 19.5459 13.2015 19.4561 13.4623 19.3561L10.3845 16.8214L10.244 16.9925L7.51665 14.7442C7.42693 14.7899 7.3372 14.834 7.24409 14.8746H7.24747ZM8.04823 14.4307L11.3969 16.5707L11.2784 16.757L14.561 18.8546C14.7997 18.7292 15.0316 18.592 15.2568 18.4497L11.661 16.1522L11.5425 16.3385L8.28863 14.2596C8.20906 14.3189 8.1295 14.3765 8.04823 14.4324V14.4307ZM8.97089 13.6428L12.6259 15.5557L12.5244 15.7523L16.2641 17.7109C16.4605 17.5466 16.6501 17.3772 16.8329 17.1993L12.8528 15.1152L12.7512 15.3118L9.15711 13.431C9.09616 13.5039 9.03522 13.5751 8.96919 13.6428H8.97089ZM9.54987 12.9007L13.6671 14.4629L13.5892 14.6696L17.7098 16.2318C17.8639 16.0369 18.0112 15.837 18.1517 15.632L13.8398 13.997L13.7619 14.2037L9.69208 12.6601C9.64637 12.7414 9.59727 12.8211 9.54649 12.899L9.54987 12.9007ZM9.98157 12.0908L14.3697 13.1921L14.3155 13.4073L18.8052 14.5341C18.9169 14.3189 19.0185 14.0969 19.1133 13.8716L14.4882 12.7109L14.4357 12.9261L10.0831 11.8333C10.051 11.9197 10.0171 12.0061 9.98157 12.0908ZM10.266 11.2148L14.8403 11.7791L14.8132 11.9993L19.5535 12.5856C19.6161 12.3534 19.6703 12.1196 19.716 11.8824L14.8996 11.2877L14.8725 11.508L10.3185 10.9437C10.3032 11.0352 10.2846 11.125 10.2643 11.2148H10.266Z" fill="white"/></svg>
          <div class="login-logo-text">LearnPlasma</div>
        </div>
        <h1>What's your name?</h1>
        <p class="subtitle">This is how others will find you on LearnPlasma.</p>
        <div class="login-label">Display name</div>
        <input class="login-input" type="text" id="registerName" placeholder="e.g. Jaime" maxlength="20" onkeydown="if(event.key==='Enter')registerUser()">
        <button class="login-btn" onclick="registerUser()">Continue</button>
      </div>
    </div>

    <!-- ===== TOP BAR ===== -->
    <div id="topbar" class="topbar" style="display:none">
      <div class="topbar-brand" onclick="showHome()">
        <svg class="plasma-logo" width="40" height="40" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19.909 10.0542C19.909 10.1559 19.909 10.2575 19.9039 10.3592H15.0621V10.1372H10.4014C10.4014 10.0915 10.4014 10.0441 10.4014 10C10.4014 9.95595 10.4014 9.90681 10.4014 9.86276H15.0621V9.64249H19.9005C19.9056 9.77974 19.909 9.91698 19.909 10.0559V10.0542ZM10.3219 9.05625L14.8826 8.49204L14.9097 8.7123L19.7261 8.11759C19.6804 7.88038 19.6246 7.64487 19.5636 7.41444L14.8234 8.00068L14.8505 8.22094L10.2677 8.78685C10.288 8.87665 10.3066 8.96645 10.3219 9.05795V9.05456V9.05625ZM10.0831 8.17011L14.4425 7.07726L14.4966 7.29244L19.1218 6.13182C19.0269 5.90647 18.9237 5.68621 18.8153 5.46933L14.3257 6.59607L14.3798 6.81125L9.98496 7.91427C10.0205 7.99898 10.0544 8.08539 10.0865 8.17181L10.0831 8.17011ZM9.69716 7.33988L13.7721 5.79465L13.8499 6.00136L18.1619 4.36632C18.0213 4.1613 17.8757 3.96137 17.72 3.76652L13.5994 5.3287L13.6773 5.53541L9.55326 7.09929C9.60405 7.17723 9.65314 7.25686 9.69885 7.33819L9.69716 7.33988ZM9.16219 6.57235L12.7614 4.68824L12.863 4.88478L16.8431 2.80075C16.6602 2.62284 16.4689 2.45341 16.2742 2.28905L12.5345 4.24771L12.6361 4.44426L8.97597 6.36056C9.0403 6.43002 9.10294 6.49949 9.16388 6.57235H9.16219ZM8.29371 5.74382L11.5526 3.66317L11.6711 3.84954L15.2669 1.55202C15.0401 1.408 14.8098 1.27245 14.5711 1.14707L11.2885 3.24466L11.407 3.43104L8.05501 5.57269C8.13796 5.62691 8.21584 5.68621 8.2954 5.74551L8.29371 5.74382ZM7.52342 5.25923L10.2541 3.00915L10.3946 3.18028L13.4707 0.645544C13.21 0.545578 12.9408 0.455778 12.67 0.377838L9.94263 2.62623L10.0831 2.79736L7.25255 5.12877C7.34566 5.16943 7.43539 5.21349 7.52512 5.25923H7.52342ZM6.50427 4.86106L8.66108 2.70417L8.81514 2.86005L11.556 0.125381C11.2597 0.0762453 10.9584 0.0406642 10.652 0.0169434L8.31403 2.35344L8.46808 2.50932L6.18939 4.78651C6.29435 4.80854 6.39931 4.83226 6.50258 4.86106H6.50427ZM5.31244 4.67977L7.03247 2.58556L7.20346 2.72619L9.44152 0C9.10124 0.0152491 8.76604 0.0491359 8.43592 0.0982718L6.65156 2.26872L6.82255 2.40935L4.96031 4.67808C5.01279 4.67808 5.06528 4.67469 5.11776 4.67469C5.18378 4.67469 5.24981 4.67469 5.31414 4.67808L5.31244 4.67977ZM4.28144 4.74246L5.60702 2.68214L5.79155 2.80244L7.39307 0.311759C7.02739 0.406642 6.66849 0.523551 6.31974 0.657404L5.19225 2.41105L5.37678 2.53135L3.909 4.81362C4.03089 4.78482 4.15617 4.7594 4.28144 4.73907V4.74246ZM3.13532 5.06269L4.08845 3.26838L4.28144 3.37343L5.54268 0.999661C5.13807 1.1979 4.7487 1.42325 4.37625 1.67231L3.65167 3.03626L3.84636 3.14131L2.72394 5.25246C2.85599 5.18468 2.99312 5.12199 3.13363 5.06608L3.13532 5.06269ZM2.31425 5.48458L2.71886 4.32904L2.92709 4.40359L3.71431 2.15859C3.31478 2.47713 2.94064 2.82447 2.59189 3.20061L2.2533 4.16638L2.46153 4.24094L1.93164 5.75229C2.05523 5.6574 2.1822 5.5693 2.31425 5.48797V5.48458ZM1.30356 6.31142L1.48302 5.47103L1.69802 5.51677L2.05861 3.82582C1.6794 4.3104 1.34419 4.82887 1.05639 5.37784L1.21722 5.41342L0.888793 6.80447C1.01746 6.63165 1.15628 6.4673 1.30526 6.31142H1.30356ZM0.560363 7.29244V6.17926C0.292879 6.89088 0.101576 7.77533 0 8.64283C0.125278 8.16164 0.31658 7.70925 0.560363 7.29075V7.29244ZM0.00677176 11.3826C0.111734 12.123 0.296264 12.8363 0.553591 13.5158V12.694C0.31658 12.2891 0.130356 11.8485 0.00677176 11.3809V11.3826ZM0.920959 13.243L1.20707 14.5866L1.04624 14.6222C1.33234 15.1728 1.66924 15.6913 2.04846 16.1742L1.68786 14.4832L1.47286 14.529L1.29171 13.6784C1.15966 13.5395 1.03439 13.3938 0.919266 13.2413L0.920959 13.243ZM1.91979 14.2426L2.45307 15.7641L2.24484 15.8387L2.58343 16.8045C2.93048 17.1789 3.30631 17.528 3.70584 17.8465L2.91863 15.6015L2.7104 15.676L2.30409 14.5137C2.17204 14.429 2.04507 14.3409 1.91979 14.2477V14.2443V14.2426ZM2.71717 14.7458L3.84128 16.8638L3.64659 16.9688L4.37117 18.3328C4.74362 18.5818 5.13299 18.8072 5.53761 19.0054L4.27637 16.6317L4.08168 16.7367L3.12517 14.9373C2.98465 14.8814 2.84752 14.817 2.71378 14.7492L2.71717 14.7458ZM3.90053 15.183L5.37 17.4687L5.18547 17.589L6.31297 19.3426C6.66172 19.4764 7.01893 19.5934 7.3863 19.6882L5.78477 17.1976L5.60024 17.3179L4.27298 15.2558C4.1477 15.2355 4.02242 15.2101 3.89884 15.1813L3.90053 15.183ZM4.95016 15.3219L6.81239 17.5906L6.6414 17.7313L8.42576 19.9017C8.75588 19.9509 9.09278 19.9848 9.43137 20L7.19161 17.2721L7.02062 17.4127L5.30059 15.3185C5.23796 15.3219 5.17532 15.3219 5.11098 15.3219C5.05681 15.3219 4.99925 15.3219 4.94508 15.3185V15.3219H4.95016ZM6.186 15.2152L8.46301 17.4907L8.30895 17.6466L10.6469 19.9831C10.9533 19.9593 11.2547 19.9238 11.5509 19.8746L8.81175 17.1366L8.656 17.2941L6.50089 15.1389C6.39931 15.166 6.29266 15.1932 6.18769 15.2135L6.186 15.2152ZM7.24747 14.8746L10.0747 17.2043L9.93417 17.3755L12.6615 19.6239C12.9324 19.5459 13.2015 19.4561 13.4623 19.3561L10.3845 16.8214L10.244 16.9925L7.51665 14.7442C7.42693 14.7899 7.3372 14.834 7.24409 14.8746H7.24747ZM8.04823 14.4307L11.3969 16.5707L11.2784 16.757L14.561 18.8546C14.7997 18.7292 15.0316 18.592 15.2568 18.4497L11.661 16.1522L11.5425 16.3385L8.28863 14.2596C8.20906 14.3189 8.1295 14.3765 8.04823 14.4324V14.4307ZM8.97089 13.6428L12.6259 15.5557L12.5244 15.7523L16.2641 17.7109C16.4605 17.5466 16.6501 17.3772 16.8329 17.1993L12.8528 15.1152L12.7512 15.3118L9.15711 13.431C9.09616 13.5039 9.03522 13.5751 8.96919 13.6428H8.97089ZM9.54987 12.9007L13.6671 14.4629L13.5892 14.6696L17.7098 16.2318C17.8639 16.0369 18.0112 15.837 18.1517 15.632L13.8398 13.997L13.7619 14.2037L9.69208 12.6601C9.64637 12.7414 9.59727 12.8211 9.54649 12.899L9.54987 12.9007ZM9.98157 12.0908L14.3697 13.1921L14.3155 13.4073L18.8052 14.5341C18.9169 14.3189 19.0185 14.0969 19.1133 13.8716L14.4882 12.7109L14.4357 12.9261L10.0831 11.8333C10.051 11.9197 10.0171 12.0061 9.98157 12.0908ZM10.266 11.2148L14.8403 11.7791L14.8132 11.9993L19.5535 12.5856C19.6161 12.3534 19.6703 12.1196 19.716 11.8824L14.8996 11.2877L14.8725 11.508L10.3185 10.9437C10.3032 11.0352 10.2846 11.125 10.2643 11.2148H10.266Z" fill="#1a1a1a"/></svg>
        <span class="topbar-brand-text">LearnPlasma</span>
      </div>
      <div class="topbar-nav">
        <button id="navPayments" onclick="showContacts()" title="View your saved payees and send payments">Payments</button>
        <div class="nav-badge-wrap"><button id="navRequests" onclick="showRequests()" title="View and create payment requests">Requests</button><div class="nav-badge" id="requestBadge" style="display:none">0</div></div>
        <button id="navHistory" onclick="showFullHistory()" title="View all past transactions">Transfer History</button>
      </div>
      <div class="topbar-profile" onclick="openSidebar()" title="Open account menu">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 21v-1a6 6 0 0 1 12 0v1"/></svg>
      </div>
    </div>

    <!-- ===== HOME ===== -->
    <div id="screenHome" class="screen">
      <div class="screen-pad">
        <div class="balance-hero">
          <div class="balance-label">Account Balance</div>
          <div class="balance-amount" id="homeBalance">$0.00</div>
          <div class="balance-currency"><span class="tip" data-tip="USDT (Tether) is a stablecoin pegged to the US Dollar. 1 USDT = $1.">USDT</span></div>
        </div>

        <div id="homePendingSection" style="display:none;margin-bottom:2rem">
          <div class="home-section-header">
            <h2>Pending Requests</h2>
            <button class="view-all" onclick="showRequests()">View all</button>
          </div>
          <div id="homePendingList"></div>
        </div>

        <div class="home-section-header">
          <h2>Recent Transactions</h2>
          <button class="view-all" onclick="showFullHistory()">View all</button>
        </div>
        <div id="historyList"><div class="empty-state">No transactions yet</div></div>

        <div class="action-cards">
          <button class="action-card" onclick="showContacts()" title="Send USDT to a contact">
            <div class="action-card-icon">&#8599;</div>
            <div class="action-card-label">Send</div>
          </button>
          <button class="action-card" onclick="showRequests()" title="Request USDT from someone">
            <div class="action-card-icon">&#8601;</div>
            <div class="action-card-label">Request</div>
          </button>
        </div>
      </div>
    </div>

    <!-- ===== PAYMENTS / CONTACTS ===== -->
    <div id="screenContacts" class="screen">
      <div class="screen-pad">
        <div class="page-title">Send Payment</div>
        <div class="payees-card">
          <div class="payees-label">Saved Payees</div>
          <div id="contactsList"></div>
        </div>
      </div>
      <button class="fab" onclick="openAddPayee()" title="Add a new payee">+</button>
    </div>

    <!-- ===== REQUESTS ===== -->
    <div id="screenRequests" class="screen">
      <div class="screen-pad">
        <div class="page-title">Requests</div>

        <div id="pendingRequestsSection" style="margin-bottom:2rem">
          <div class="home-section-header">
            <h2>Pending Requests</h2>
          </div>
          <div id="pendingRequestsList"><div class="empty-state">No pending requests</div></div>
        </div>

        <div id="outgoingRequestsSection" style="margin-bottom:2rem">
          <div class="home-section-header">
            <h2>Your Outgoing Requests</h2>
          </div>
          <div id="outgoingRequestsList"><div class="empty-state">No outgoing requests</div></div>
        </div>

        <div class="page-title" style="margin-top:1rem">New Request</div>
        <div class="payees-card">
          <div class="payees-label">Request From</div>
          <div id="requestContactsList"></div>
        </div>
      </div>
      <button class="fab" onclick="openAddPayee()" title="Add a new payee">+</button>
    </div>

    <!-- ===== ADD PAYEE MODAL ===== -->
    <div class="modal-overlay" id="addPayeeModal" onclick="if(event.target===this)closeAddPayee()">
      <div class="modal">
        <h2>Add New Payee</h2>
        <p>Enter their wallet address to add them as a payee. They must have the Plasma Testnet wallet set up.</p>
        <input class="modal-input" id="payeeAddress" type="text" placeholder="0x... wallet address">
        <input class="modal-input" id="payeeName" type="text" placeholder="Display name (e.g. Alice)" maxlength="20">
        <div class="modal-buttons">
          <button class="btn btn-outline" onclick="closeAddPayee()">Cancel</button>
          <button class="btn btn-primary" id="addPayeeBtn" onclick="addPayee()">Add Payee</button>
        </div>
        <div id="addPayeeResult"></div>
      </div>
    </div>

    <!-- ===== AMOUNT ===== -->
    <div id="screenAmount" class="screen">
      <div class="screen-pad">
        <div class="page-header">
          <button class="back-link" onclick="flowMode==='send'?showContacts():showRequests()">&larr; Back</button>
        </div>
        <div class="amount-display">
          <div class="amount-to"><span id="amountToLabel">Sending to</span> <span id="amountToName">â€”</span></div>
          <div class="amount-value"><span class="currency">$</span><span id="amountDisplay">0</span></div>
        </div>
        <div class="numpad">
          <button onclick="numInput('1')">1</button>
          <button onclick="numInput('2')">2</button>
          <button onclick="numInput('3')">3</button>
          <button onclick="numInput('4')">4</button>
          <button onclick="numInput('5')">5</button>
          <button onclick="numInput('6')">6</button>
          <button onclick="numInput('7')">7</button>
          <button onclick="numInput('8')">8</button>
          <button onclick="numInput('9')">9</button>
          <button onclick="numInput('.')">.</button>
          <button onclick="numInput('0')">0</button>
          <button onclick="numDelete()">&#9003;</button>
        </div>
        <div style="max-width:400px;margin:0 auto">
          <button class="btn btn-primary" onclick="showPreview()">Next</button>
        </div>
      </div>
    </div>

    <!-- ===== PREVIEW ===== -->
    <div id="screenPreview" class="screen">
      <div class="screen-pad">
        <div class="page-header">
          <button class="back-link" onclick="showAmount()">&larr; Back</button>
        </div>
        <div class="preview-card">
          <div class="preview-avatars">
            <div class="preview-avatar" id="previewFromAvatar">J</div>
            <div class="preview-arrow">&rarr;</div>
            <div class="preview-avatar" id="previewToAvatar">N</div>
          </div>
          <div class="preview-amount" id="previewAmount">$10</div>
          <div class="preview-desc" id="previewDesc">will be sent to Nele</div>
          <div class="preview-fee"><span class="tip" data-tip="LearnPlasma doesn't charge fees. A tiny XPL gas fee is paid to the network automatically." style="border:none;color:inherit">No fees</span></div>
        </div>
        <div class="preview-details">
          <div class="preview-row"><span class="label">From</span><span id="previewFrom">Jaime</span></div>
          <div class="preview-row"><span class="label">To</span><span id="previewTo">Nele</span></div>
          <div class="preview-row"><span class="label">Amount</span><span id="previewUSDT">$10.00</span></div>
          <div class="preview-row"><span class="label"><span class="tip" data-tip="A tiny fee (paid in XPL) to process your transaction on the Plasma blockchain. Usually fractions of a cent.">Network fee</span></span><span style="color:var(--green)">$0.00</span></div>
        </div>
        <button class="btn btn-primary" id="confirmBtn" onclick="confirmPayment()">Confirm &amp; Send</button>
      </div>
    </div>

    <!-- ===== RECEIPT ===== -->
    <div id="screenReceipt" class="screen receipt-screen">
      <div class="receipt-check">&#10003;</div>
      <div class="receipt-amount" id="receiptAmount">$10</div>
      <div class="receipt-desc" id="receiptDesc">Sent to Nele</div>
      <div class="receipt-buttons">
        <button class="btn btn-primary" onclick="showContacts()">Send again</button>
        <button class="btn btn-outline" onclick="showHome()">Back to home</button>
      </div>
    </div>

    <!-- ===== FULL HISTORY ===== -->
    <div id="screenFullHistory" class="screen">
      <div class="screen-pad">
        <div class="balance-hero">
          <div class="balance-label">Account Balance</div>
          <div class="balance-amount" id="historyBalance">$0.00</div>
          <div class="balance-currency"><span class="tip" data-tip="USDT (Tether) is a stablecoin pegged to the US Dollar. 1 USDT = $1.">USDT</span></div>
        </div>
        <div id="fullHistoryList"><div class="empty-state">No transactions yet</div></div>
      </div>
    </div>

    <!-- ===== ACCOUNT SIDEBAR ===== -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>Account</h2>
        <button class="sidebar-close" onclick="closeSidebar()">&times;</button>
      </div>
      <button class="sidebar-menu-item" onclick="closeSidebar()" title="View your wallet address and account info">
        <span class="sidebar-menu-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 21v-1a6 6 0 0 1 12 0v1"/></svg></span>
        Account Details
      </button>
      <button class="sidebar-menu-item" title="Manage your app settings">
        <span class="sidebar-menu-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></span>
        Settings
      </button>
      <button class="sidebar-menu-item" title="View your notifications">
        <span class="sidebar-menu-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg></span>
        Notifications
      </button>
      <button class="sidebar-menu-item" title="Manage your privacy settings">
        <span class="sidebar-menu-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></span>
        Privacy
      </button>
      <button class="sidebar-menu-item" onclick="closeSidebar();toggleChat()" title="Chat with Plasma Coach AI assistant">
        <span class="sidebar-menu-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span>
        Plasma Coach
      </button>
      <button class="sidebar-menu-item" onclick="closeSidebar();showGlossary()" title="Look up blockchain and crypto terms">
        <span class="sidebar-menu-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></span>
        Glossary
      </button>
      <button class="sidebar-menu-item" onclick="closeSidebar();startWalkthrough()" title="Take a step-by-step tour of the app">
        <span class="sidebar-menu-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span>
        Guided Tour
      </button>
      <button class="sidebar-menu-item" title="Get in touch with us">
        <span class="sidebar-menu-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></span>
        Contact
      </button>
      <a href="https://www.plasma.to/one" target="_blank" rel="noopener" class="sidebar-menu-item" title="Visit Plasma One" style="text-decoration:none;color:var(--green)">
        <span class="sidebar-menu-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></span>
        Visit Plasma One
      </a>
    </div>

    <!-- ===== GLOSSARY ===== -->
    <div id="screenGlossary" class="screen">
      <div class="screen-pad">
        <div class="page-header">
          <button class="back-link" onclick="showHome()">&larr; Back</button>
          <h2>Glossary</h2>
        </div>
        <div id="glossaryContent"></div>
      </div>
    </div>

    <!-- ===== WALKTHROUGH ===== -->
    <div class="walkthrough-overlay" id="walkthroughOverlay">
      <div class="walkthrough-highlight" id="wtHighlight"></div>
      <div class="walkthrough-box" id="wtBox">
        <h3 id="wtTitle"></h3>
        <p id="wtText"></p>
        <div class="wt-btns">
          <span class="wt-step" id="wtStep"></span>
          <div>
            <button class="wt-skip" onclick="endWalkthrough()">Skip</button>
            <button class="wt-next" id="wtNext" onclick="nextWalkthroughStep()">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PLASMA COACH CHAT ===== -->
    <button class="coach-fab" id="coachFab" onclick="toggleChat()" title="Open Plasma Coach">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    </button>
    <div class="coach-panel" id="coachPanel">
      <div class="coach-header">
        <span class="coach-header-icon">&#10024;</span>
        <span class="coach-header-title">Plasma Coach</span>
        <select class="coach-level-select" id="coachLevel" onchange="coachKnowledgeLevel=this.value" title="Your experience level">
          <option value="beginner">Beginner</option>
          <option value="intermediate">Intermediate</option>
          <option value="experienced">Experienced</option>
        </select>
        <button class="coach-close" onclick="toggleChat()" title="Close chat">&times;</button>
      </div>
      <div class="coach-messages" id="coachMessages">
        <div class="coach-msg assistant">Hi there! I'm Plasma Coach, your personal guide to learning about stablecoin payments. Ask me anything about LearnPlasma, stablecoins, or how to use this platform.</div>
      </div>
      <div class="coach-typing" id="coachTyping">
        <div class="coach-typing-dot"></div>
        <div class="coach-typing-dot"></div>
        <div class="coach-typing-dot"></div>
      </div>
      <div class="coach-input-bar">
        <input class="coach-input" id="coachInput" type="text" placeholder="Ask Plasma Coach..." onkeydown="if(event.key==='Enter')sendChatMessage()">
        <button class="coach-send" id="coachSendBtn" onclick="sendChatMessage()" title="Send message">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <script>
    function showToast(msg, type) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.className = "toast show" + (type === "error" ? " toast-error" : type === "success" ? " toast-success" : "");
      setTimeout(() => { t.className = "toast"; }, 3500);
    }
    const CONTRACT_ADDRESS = "0xd9DEBe4f00fe7AbD7921CA0Dec92433495b8F0AF";
    const USDT_ADDRESS = "0x502012b361AebCE43b26Ec812B74D9a51dB4D412";
    const ABI = [
      "function register(string calldata name) external",
      "function sendByName(string calldata toName, uint256 amount) external",
      "function addressToName(address) view returns (string)",
      "function nameToAddress(string) view returns (address)",
      "function getContacts() view returns (string[] names, address[] addrs)",
      "function getMyHistory() view returns (tuple(address from, address to, string fromName, string toName, uint256 amount, uint256 timestamp)[])",
      "event UserRegistered(address indexed user, string name)",
      "event PaymentSent(address indexed from, address indexed to, string fromName, string toName, uint256 amount, uint256 timestamp)",
      "function requestByName(string calldata payerName, uint256 amount) external",
      "function fulfillRequest(uint256 requestId) external",
      "function getMyPendingRequests() view returns (tuple(uint256 id, address requester, address payer, string requesterName, string payerName, uint256 amount, uint256 timestamp, bool fulfilled, bool cancelled)[])",
      "function getMyOutgoingRequests() view returns (tuple(uint256 id, address requester, address payer, string requesterName, string payerName, uint256 amount, uint256 timestamp, bool fulfilled, bool cancelled)[])"
    ];
    const ERC20_ABI = [
      "function balanceOf(address) view returns (uint256)",
      "function decimals() view returns (uint8)",
      "function allowance(address owner, address spender) view returns (uint256)",
      "function approve(address spender, uint256 amount) returns (bool)"
    ];
    let usdtDecimals = 6;
    let provider, signer, contract, usdtContract, myAddress, myName;
    let selectedContact = { name: "", addr: "" };
    let amountStr = "0";
    let flowMode = "send"; // "send" or "request"

    function showScreen(id) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }
    function setActiveNav(btnId) {
      document.querySelectorAll(".topbar-nav button").forEach(b => b.classList.remove("active"));
      if (btnId) document.getElementById(btnId).classList.add("active");
    }
    function showTopbar() { document.getElementById("topbar").style.display = "flex"; }

    function openSidebar() {
      document.getElementById("sidebar").classList.add("open");
      document.getElementById("sidebarOverlay").classList.add("open");
    }
    function closeSidebar() {
      document.getElementById("sidebar").classList.remove("open");
      document.getElementById("sidebarOverlay").classList.remove("open");
    }

    async function connectWallet() {
      if (!window.ethereum) {
        showToast("Please install MetaMask and add Plasma Testnet (Chain ID 9746)", "error");
        return;
      }
      try {
        await window.ethereum.request({ method: "eth_requestAccounts" });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        const network = await provider.getNetwork();
        if (network.chainId !== 9746) {
          showToast("Please switch MetaMask to Plasma Testnet (Chain ID 9746)", "error");
          return;
        }
        signer = provider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        usdtContract = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);
        myAddress = await signer.getAddress();
        try { usdtDecimals = await usdtContract.decimals(); } catch(e) { usdtDecimals = 6; }
        myName = await contract.addressToName(myAddress);
        if (myName && myName.length > 0) {
          showTopbar();
          await showHome();
        } else {
          showScreen("screenRegister");
        }
      } catch (e) {
        console.error("Connect error:", e);
        showToast("Connection failed: " + (e.reason || e.message), "error");
      }
    }

    async function registerUser() {
      const name = document.getElementById("registerName").value.trim();
      if (!name) return;
      try {
        const tx = await contract.register(name);
        await tx.wait();
        myName = name;
        showTopbar();
        await showHome();
      } catch (e) { showToast("Registration failed: " + (e.reason || e.message), "error"); }
    }

    async function getUSDTBalance() {
      try {
        const decimals = await usdtContract.decimals();
        const bal = await usdtContract.balanceOf(myAddress);
        return parseFloat(ethers.utils.formatUnits(bal, decimals));
      } catch (e) { return 0; }
    }

    let wtAutoStarted = false;
    async function showHome() {
      setActiveNav(null);
      showScreen("screenHome");
      try {
        const usdt = await getUSDTBalance();
        document.getElementById("homeBalance").textContent = "$" + usdt.toFixed(2);
        await refreshPendingRequests();
        await loadHistory("historyList", 4);
      } catch (e) { console.error("showHome error:", e); }
      if (!wtAutoStarted) {
        wtAutoStarted = true;
        setTimeout(() => { startWalkthrough(); }, 300);
      }
    }

    async function refreshPendingRequests() {
      try {
        const reqs = await contract.getMyPendingRequests();
        const badge = document.getElementById("requestBadge");
        const section = document.getElementById("homePendingSection");
        const list = document.getElementById("homePendingList");
        if (reqs.length === 0) {
          badge.style.display = "none";
          section.style.display = "none";
          return;
        }
        badge.textContent = reqs.length;
        badge.style.display = "flex";
        section.style.display = "block";
        let html = '<div class="tx-card">';
        for (const r of reqs) {
          const amt = parseFloat(ethers.utils.formatUnits(r.amount, usdtDecimals)).toFixed(2);
          html += `
            <div class="tx-item">
              <div class="tx-icon" style="background:#fef2f2;color:#dc2626">&#8601;</div>
              <div class="tx-info">
                <div class="tx-name">${r.requesterName} requested $${amt}</div>
                <div class="tx-verified" style="color:var(--muted)">Tap Pay to accept</div>
              </div>
              <button class="btn btn-primary" style="width:auto;padding:0.5rem 1rem;font-size:0.85rem" onclick="fulfillRequest(${r.id})">Pay</button>
            </div>`;
        }
        html += '</div>';
        list.innerHTML = html;
      } catch (e) { console.error("Pending refresh error:", e); }
    }

    async function loadHistory(elementId, limit) {
      try {
        const history = await contract.getMyHistory();
        const listEl = document.getElementById(elementId);
        if (history.length === 0) {
          listEl.innerHTML = '<div class="empty-state">No transactions yet</div>';
          return;
        }
        listEl.innerHTML = "";
        const count = limit ? Math.min(limit, history.length) : history.length;
        let currentLabel = "";
        let cardHtml = "";
        let items = [];

        for (let i = history.length - 1; i >= history.length - count; i--) {
          const p = history[i];
          const isSender = p.from.toLowerCase() === myAddress.toLowerCase();
          const name = isSender ? p.toName : p.fromName;
          const usdAmt = parseFloat(ethers.utils.formatUnits(p.amount, usdtDecimals)).toFixed(2);
          const date = new Date(p.timestamp.toNumber() * 1000);
          const now = new Date();
          let label = date.toLocaleDateString([], { day: "numeric", month: "short" });
          const diffDays = Math.floor((now - date) / 86400000);
          if (diffDays === 0) label = "TODAY";
          else if (diffDays === 1) label = "YESTERDAY";
          else if (diffDays < 7) label = "THIS WEEK";

          items.push({ name, isSender, usdAmt, label, date });
        }

        let html = "";
        let lastLabel = "";
        let inCard = false;
        for (const item of items) {
          if (item.label !== lastLabel) {
            if (inCard) html += '</div>';
            html += `<div class="tx-date-label">${item.label}</div><div class="tx-card">`;
            inCard = true;
            lastLabel = item.label;
          }
          const arrow = item.isSender ? "&#8599;" : "&#8601;";
          html += `
            <div class="tx-item">
              <div class="tx-icon">${arrow}</div>
              <div class="tx-info">
                <div class="tx-name">${item.name}</div>
                <div class="tx-verified"><svg width="12" height="12" viewBox="0 0 24 24" fill="var(--green)" stroke="none"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg> <span class="tip" data-tip="This transaction was confirmed on the Plasma blockchain and cannot be reversed." style="border-color:var(--green)">Verified</span></div>
              </div>
              <div class="tx-amount ${item.isSender ? "outflow" : "inflow"}">${item.isSender ? "-" : "+"}$${item.usdAmt}</div>
            </div>`;
        }
        if (inCard) html += '</div>';
        listEl.innerHTML = html;
      } catch (e) { console.error("History error:", e); }
    }

    async function loadContactsList(elementId, onClickFn) {
      const listEl = document.getElementById(elementId);
      listEl.innerHTML = '<div class="empty-state">Loading...</div>';
      try {
        const [names, addrs] = await contract.getContacts();
        let contacts = [];
        for (let i = 0; i < names.length; i++) {
          if (addrs[i].toLowerCase() === myAddress.toLowerCase()) continue;
          contacts.push({ name: names[i], addr: addrs[i] });
        }
        contacts.sort((a, b) => a.name.localeCompare(b.name));
        if (contacts.length === 0) { listEl.innerHTML = '<div class="empty-state">No contacts found</div>'; return; }

        let html = "";
        let lastLetter = "";
        for (const c of contacts) {
          const letter = c.name.charAt(0).toUpperCase();
          if (letter !== lastLetter) {
            html += `<div class="payee-group-letter">${letter}</div>`;
            lastLetter = letter;
          }
          const initials = c.name.substring(0, 2).toUpperCase();
          const isBot = c.name === "PracticeBot";
          html += `
            <div class="payee-item" onclick="${onClickFn}('${c.name}', '${c.addr}')">
              <div class="payee-avatar" ${isBot ? 'style="background:var(--green)"' : ''}>${isBot ? 'ðŸ¤–' : initials}</div>
              <div class="payee-name">${c.name}${isBot ? ' <span style="font-size:0.75rem;color:var(--green);font-weight:600;margin-left:0.5rem;background:var(--green-light);padding:0.15rem 0.5rem;border-radius:8px">Practice Account</span>' : ''}</div>
            </div>`;
        }
        listEl.innerHTML = html;
      } catch (e) { listEl.innerHTML = '<div class="empty-state">Error loading contacts</div>'; }
    }

    async function showContacts() {
      setActiveNav("navPayments");
      showScreen("screenContacts");
      await loadContactsList("contactsList", "selectContact");
    }

    async function showRequests() {
      setActiveNav("navRequests");
      showScreen("screenRequests");
      await loadPendingRequests();
      await loadOutgoingRequests();
      await loadContactsList("requestContactsList", "selectRequestContact");
    }

    function selectContact(name, addr) {
      flowMode = "send";
      selectedContact = { name, addr };
      amountStr = "0";
      document.getElementById("amountDisplay").textContent = "0";
      document.getElementById("amountToName").textContent = name;
      document.getElementById("amountToLabel").textContent = "Sending to";
      showScreen("screenAmount");
    }

    function selectRequestContact(name, addr) {
      flowMode = "request";
      selectedContact = { name, addr };
      amountStr = "0";
      document.getElementById("amountDisplay").textContent = "0";
      document.getElementById("amountToName").textContent = name;
      document.getElementById("amountToLabel").textContent = "Requesting from";
      showScreen("screenAmount");
    }

    function numInput(ch) {
      if (amountStr === "0" && ch !== ".") amountStr = ch;
      else if (ch === "." && amountStr.includes(".")) return;
      else if (amountStr.includes(".") && amountStr.split(".")[1].length >= 2) return;
      else amountStr += ch;
      document.getElementById("amountDisplay").textContent = amountStr;
    }
    function numDelete() {
      amountStr = amountStr.slice(0, -1) || "0";
      document.getElementById("amountDisplay").textContent = amountStr;
    }
    function showAmount() { showScreen("screenAmount"); }

    function showPreview() {
      const usd = parseFloat(amountStr);
      if (!usd || usd <= 0) return;
      if (flowMode === "send") {
        document.getElementById("previewFromAvatar").textContent = myName.substring(0, 2).toUpperCase();
        document.getElementById("previewToAvatar").textContent = selectedContact.name.substring(0, 2).toUpperCase();
        document.getElementById("previewDesc").textContent = "will be sent to " + selectedContact.name;
        document.getElementById("previewFrom").textContent = myName;
        document.getElementById("previewTo").textContent = selectedContact.name;
        document.getElementById("confirmBtn").textContent = "Confirm & Send";
      } else {
        document.getElementById("previewFromAvatar").textContent = selectedContact.name.substring(0, 2).toUpperCase();
        document.getElementById("previewToAvatar").textContent = myName.substring(0, 2).toUpperCase();
        document.getElementById("previewDesc").textContent = "will be requested from " + selectedContact.name;
        document.getElementById("previewFrom").textContent = selectedContact.name;
        document.getElementById("previewTo").textContent = myName;
        document.getElementById("confirmBtn").textContent = "Send Request";
      }
      document.getElementById("previewAmount").textContent = "$" + amountStr;
      document.getElementById("previewUSDT").textContent = "$" + parseFloat(amountStr).toFixed(2);
      showScreen("screenPreview");
    }

    async function confirmPayment() {
      const usd = parseFloat(amountStr);
      const usdtAmount = ethers.utils.parseUnits(usd.toFixed(usdtDecimals), usdtDecimals);
      const btn = document.getElementById("confirmBtn");
      try {
        if (flowMode === "send") {
          btn.textContent = "Approving..."; btn.disabled = true;
          const allowance = await usdtContract.allowance(myAddress, CONTRACT_ADDRESS);
          if (allowance.lt(usdtAmount)) {
            const approveTx = await usdtContract.approve(CONTRACT_ADDRESS, ethers.constants.MaxUint256);
            await approveTx.wait();
          }
          btn.textContent = "Sending...";
          const tx = await contract.sendByName(selectedContact.name, usdtAmount);
          await tx.wait();
          document.getElementById("receiptAmount").textContent = "$" + amountStr;
          document.getElementById("receiptDesc").textContent = "Sent to " + selectedContact.name;
          getUSDTBalance().then(usdt => {
            document.getElementById("homeBalance").textContent = "$" + usdt.toFixed(2);
          });
        } else {
          btn.textContent = "Requesting..."; btn.disabled = true;
          const tx = await contract.requestByName(selectedContact.name, usdtAmount);
          await tx.wait();
          document.getElementById("receiptAmount").textContent = "$" + amountStr;
          document.getElementById("receiptDesc").textContent = "Requested from " + selectedContact.name;
        }
        btn.textContent = "Confirm & Send"; btn.disabled = false;
        showScreen("screenReceipt");
      } catch (e) {
        btn.textContent = flowMode === "send" ? "Confirm & Send" : "Send Request";
        btn.disabled = false;
        showToast("Failed: " + (e.reason || e.message), "error");
      }
    }

    async function loadPendingRequests() {
      const el = document.getElementById("pendingRequestsList");
      try {
        const reqs = await contract.getMyPendingRequests();
        if (reqs.length === 0) { el.innerHTML = '<div class="empty-state">No pending requests</div>'; return; }
        let html = '<div class="tx-card">';
        for (const r of reqs) {
          const amt = parseFloat(ethers.utils.formatUnits(r.amount, usdtDecimals)).toFixed(2);
          html += `
            <div class="tx-item">
              <div class="tx-icon">&#8601;</div>
              <div class="tx-info">
                <div class="tx-name">${r.requesterName} requested $${amt}</div>
                <div class="tx-verified" style="color:var(--muted)">Tap Pay to send</div>
              </div>
              <button class="btn btn-primary" style="width:auto;padding:0.5rem 1rem;font-size:0.85rem" onclick="fulfillRequest(${r.id})">Pay</button>
            </div>`;
        }
        html += '</div>';
        el.innerHTML = html;
      } catch (e) { el.innerHTML = '<div class="empty-state">Error loading requests</div>'; }
    }

    async function loadOutgoingRequests() {
      const el = document.getElementById("outgoingRequestsList");
      try {
        const reqs = await contract.getMyOutgoingRequests();
        if (reqs.length === 0) { el.innerHTML = '<div class="empty-state">No outgoing requests</div>'; return; }
        let html = '<div class="tx-card">';
        for (const r of reqs) {
          const amt = parseFloat(ethers.utils.formatUnits(r.amount, usdtDecimals)).toFixed(2);
          html += `
            <div class="tx-item">
              <div class="tx-icon">&#8987;</div>
              <div class="tx-info">
                <div class="tx-name">$${amt} from ${r.payerName}</div>
                <div class="tx-verified" style="color:var(--muted)">Waiting for payment</div>
              </div>
              <div class="tx-amount" style="color:var(--muted)">Pending</div>
            </div>`;
        }
        html += '</div>';
        el.innerHTML = html;
      } catch (e) { el.innerHTML = '<div class="empty-state">Error loading requests</div>'; }
    }

    async function fulfillRequest(requestId) {
      // Save details before transaction so we have them for the receipt
      let reqName = "";
      let reqAmt = "";
      try {
        const reqs = await contract.getMyPendingRequests();
        const req = reqs.find(r => r.id.toNumber() === requestId);
        if (!req) { showToast("Request not found", "error"); return; }
        reqName = req.requesterName;
        reqAmt = parseFloat(ethers.utils.formatUnits(req.amount, usdtDecimals)).toFixed(2);

        const allowance = await usdtContract.allowance(myAddress, CONTRACT_ADDRESS);
        if (allowance.lt(req.amount)) {
          const approveTx = await usdtContract.approve(CONTRACT_ADDRESS, ethers.constants.MaxUint256);
          await approveTx.wait();
        }
        const tx = await contract.fulfillRequest(requestId);
        await tx.wait();
      } catch (e) {
        showToast("Payment failed: " + (e.reason || e.message), "error");
        return;
      }
      // Transaction succeeded â€” show receipt
      document.getElementById("receiptAmount").textContent = "$" + reqAmt;
      document.getElementById("receiptDesc").textContent = "Sent to " + reqName;
      showScreen("screenReceipt");
      getUSDTBalance().then(usdt => {
        document.getElementById("homeBalance").textContent = "$" + usdt.toFixed(2);
      }).catch(() => {});
    }

    function openAddPayee() {
      document.getElementById("addPayeeModal").classList.add("open");
      document.getElementById("payeeAddress").value = "";
      document.getElementById("payeeName").value = "";
      document.getElementById("addPayeeResult").innerHTML = "";
    }
    function closeAddPayee() {
      document.getElementById("addPayeeModal").classList.remove("open");
    }

    async function addPayee() {
      const addr = document.getElementById("payeeAddress").value.trim();
      const name = document.getElementById("payeeName").value.trim();
      const resultEl = document.getElementById("addPayeeResult");
      const btn = document.getElementById("addPayeeBtn");

      if (!addr || !addr.startsWith("0x") || addr.length !== 42) {
        resultEl.innerHTML = '<div class="modal-result not-found">Please enter a valid wallet address (0x...)</div>';
        return;
      }
      if (!name) {
        resultEl.innerHTML = '<div class="modal-result not-found">Please enter a display name</div>';
        return;
      }

      btn.textContent = "Checking..."; btn.disabled = true;
      try {
        // Check if this address is already registered
        const existingName = await contract.addressToName(addr);
        if (existingName && existingName.length > 0) {
          resultEl.innerHTML = '<div class="modal-result found">This address is already registered as <strong>' + existingName + '</strong>. You can find them in your payee list.</div>';
          btn.textContent = "Add Payee"; btn.disabled = false;
          return;
        }

        // Check if name is taken
        const existingAddr = await contract.nameToAddress(name);
        if (existingAddr !== "0x0000000000000000000000000000000000000000") {
          resultEl.innerHTML = '<div class="modal-result not-found">The name "' + name + '" is already taken. Choose a different name.</div>';
          btn.textContent = "Add Payee"; btn.disabled = false;
          return;
        }

        // Register the new payee â€” this registers them from YOUR wallet as a known contact
        // Note: On-chain, only the wallet owner can register themselves.
        // So we show instructions instead.
        resultEl.innerHTML = '<div class="modal-result not-found">' +
          'This address is not registered yet. Ask them to:<br><br>' +
          '1. Open <strong>jaimelewis256.github.io/my-plasma-project</strong><br>' +
          '2. Connect their MetaMask (Plasma Testnet)<br>' +
          '3. Register with the name <strong>"' + name + '"</strong><br><br>' +
          'Once registered, they will appear in your payee list.</div>';
        btn.textContent = "Add Payee"; btn.disabled = false;
      } catch (e) {
        resultEl.innerHTML = '<div class="modal-result not-found">Error: ' + (e.reason || e.message) + '</div>';
        btn.textContent = "Add Payee"; btn.disabled = false;
      }
    }

    async function showFullHistory() {
      setActiveNav("navHistory");
      showScreen("screenFullHistory");
      const usdt = await getUSDTBalance();
      document.getElementById("historyBalance").textContent = "$" + usdt.toFixed(2);
      await loadHistory("fullHistoryList", null);
    }

    // Poll for new pending requests every 15 seconds
    setInterval(async () => {
      if (contract && myAddress) {
        await refreshPendingRequests();
      }
    }, 15000);

    if (window.ethereum) {
      window.ethereum.on("accountsChanged", () => location.reload());
      window.ethereum.on("chainChanged", () => location.reload());
    }
    window.addEventListener("load", function() {
      const btn = document.getElementById("connectBtn");
      if (typeof ethers === "undefined") { btn.textContent = "ERROR: ethers.js failed to load"; btn.style.background = "#dc2626"; btn.style.color = "#fff"; return; }
      if (!window.ethereum) { btn.textContent = "MetaMask not detected"; btn.style.background = "#dc2626"; btn.style.color = "#fff"; return; }
    });

    // ===== GLOSSARY =====
    const glossaryData = [
      { term: "Allowance", def: "Permission you give a smart contract to spend your tokens. Before the contract can move your USDT, you must set an allowance." },
      { term: "Approval", def: "The transaction that sets an allowance. You approve a smart contract to spend up to a certain amount of your tokens." },
      { term: "Block", def: "A group of transactions bundled together and added to the blockchain. Each block is linked to the previous one, forming a chain." },
      { term: "Block Explorer", def: "A website to view transactions on the blockchain (e.g. PlasmaScan). You can look up any transaction, address, or block." },
      { term: "Blockchain", def: "A shared digital ledger that records transactions across many computers. Once recorded, the data cannot be changed, making it secure and transparent." },
      { term: "Chain ID", def: "A unique number identifying a blockchain network. The Plasma Testnet uses Chain ID 9746." },
      { term: "Confirmation", def: "When a transaction is verified and added to a block. Once confirmed, a transaction is permanent and cannot be reversed." },
      { term: "DApp", def: "Decentralised Application. An app that runs on a blockchain instead of a central server. LearnPlasma is a DApp." },
      { term: "Decentralisation", def: "No single person or company controls the network. Instead, many computers around the world work together to keep it running." },
      { term: "ERC-20", def: "A standard for creating tokens on Ethereum-compatible blockchains. USDT follows this standard, which is why any wallet can send and receive it." },
      { term: "Gas Fee", def: "A small fee paid in XPL to process your transaction on the Plasma blockchain. Think of it like postage for sending a letter. Usually fractions of a cent." },
      { term: "Hash", def: "A unique fingerprint for a transaction or block. It's a long string of letters and numbers that identifies it on the blockchain." },
      { term: "MetaMask", def: "A browser extension that acts as your crypto wallet. It stores your private keys and lets you approve transactions on blockchain apps." },
      { term: "Plasma", def: "A blockchain designed for fast, low-cost stablecoin payments. It's where LearnPlasma runs." },
      { term: "Private Key", def: "A secret code that proves you own your wallet. Never share it with anyone. Think of it as the password to your bank account." },
      { term: "Public Address", def: "Your wallet's address (starts with 0x). You can share this with others so they can send you money. Like a bank account number." },
      { term: "RPC", def: "Remote Procedure Call â€” how your wallet talks to the blockchain. When you send a transaction, MetaMask uses an RPC endpoint to relay it to the network." },
      { term: "Smart Contract", def: "A program stored on the blockchain that automatically executes when conditions are met. LearnPlasma uses a smart contract to handle payments and requests." },
      { term: "Stablecoin", def: "A cryptocurrency designed to maintain a stable value, usually pegged to a real currency like the US Dollar. USDT is a stablecoin." },
      { term: "Testnet", def: "A test version of a blockchain for developers to experiment without using real money. All tokens on testnet have no real value." },
      { term: "Token", def: "A digital asset on a blockchain (like USDT). Tokens follow standards like ERC-20 so they work across different wallets and apps." },
      { term: "Transaction", def: "A transfer of value recorded on the blockchain. Once confirmed, it cannot be undone. Each transaction has a unique ID and timestamp." },
      { term: "USDT", def: "Tether â€” a stablecoin pegged to the US Dollar (1 USDT = $1). This is the currency used for payments in LearnPlasma." },
      { term: "Wallet", def: "A digital tool that stores your cryptocurrency and lets you send/receive it. Your MetaMask is your wallet." },
      { term: "Wei", def: "The smallest unit of cryptocurrency, like cents to dollars. 1 token = 1,000,000,000,000,000,000 wei (18 decimal places)." },
      { term: "XPL", def: "The native token of the Plasma blockchain, used to pay gas fees. You need a small amount of XPL to process transactions, even though payments are in USDT." }
    ];

    function showGlossary() {
      setActiveNav(null);
      showScreen("screenGlossary");
      const el = document.getElementById("glossaryContent");
      let html = "";
      let lastLetter = "";
      for (const g of glossaryData) {
        const letter = g.term.charAt(0).toUpperCase();
        if (letter !== lastLetter) {
          html += `<div class="glossary-letter">${letter}</div>`;
          lastLetter = letter;
        }
        html += `<div class="glossary-item"><div class="glossary-term">${g.term}</div><div class="glossary-def">${g.def}</div></div>`;
      }
      el.innerHTML = html;
    }

    // ===== WALKTHROUGH =====
    const walkthroughSteps = [
      { el: "#homeBalance", title: "Your Balance", text: "This shows your USDT balance â€” the money available in your wallet. USDT is a stablecoin worth $1 each.", pos: "below", nav: "home" },
      { el: ".action-card:first-child", title: "Send Money", text: "Tap here to send USDT to someone. You'll choose a contact, use a keypad to enter the amount, then preview before confirming.", pos: "above", nav: "home" },
      { el: ".action-card:last-child", title: "Request Money", text: "Request USDT from someone. They'll see your request and can approve it with one tap.", pos: "above", nav: "home" },
      { el: "#navPayments", title: "Payments Tab", text: "See all your contacts and choose who to send money to.", pos: "below", nav: "home" },
      { el: ".fab", title: "Add Payee", text: "Tap the + button to add a new payee by entering their wallet address and display name.", pos: "above", nav: "contacts" },
      { el: "#navRequests", title: "Requests Tab", text: "View pending requests from others, your outgoing requests, and create new payment requests.", pos: "below", nav: "home" },
      { el: "#navHistory", title: "Transfer History", text: "View all your past transactions â€” both sent and received â€” with dates and amounts.", pos: "below", nav: "home" },
      { el: ".topbar-profile", title: "Account Menu", text: "Access your account settings, the Glossary of blockchain terms, or restart this guided tour anytime.", pos: "below", nav: "home" }
    ];
    let wtCurrent = 0;

    function startWalkthrough() {
      wtCurrent = 0;
      wtNavigateAndShow();
    }

    function wtNavigateAndShow() {
      if (wtCurrent >= walkthroughSteps.length) { endWalkthrough(); return; }
      const step = walkthroughSteps[wtCurrent];
      const screenMap = { home: "screenHome", contacts: "screenContacts", requests: "screenRequests", history: "screenFullHistory", amount: "screenAmount" };
      if (screenMap[step.nav]) showScreen(screenMap[step.nav]);
      setTimeout(() => { showWalkthroughStep(); }, 150);
    }

    function showWalkthroughStep() {
      const overlay = document.getElementById("walkthroughOverlay");
      const highlight = document.getElementById("wtHighlight");
      const box = document.getElementById("wtBox");
      if (wtCurrent >= walkthroughSteps.length) { endWalkthrough(); return; }

      const step = walkthroughSteps[wtCurrent];
      const target = document.querySelector(step.el);
      if (!target) { wtCurrent++; wtNavigateAndShow(); return; }

      overlay.classList.add("active");
      const rect = target.getBoundingClientRect();
      const pad = 8;
      highlight.style.left = (rect.left - pad) + "px";
      highlight.style.top = (rect.top - pad) + "px";
      highlight.style.width = (rect.width + pad * 2) + "px";
      highlight.style.height = (rect.height + pad * 2) + "px";

      document.getElementById("wtTitle").textContent = step.title;
      document.getElementById("wtText").textContent = step.text;
      document.getElementById("wtStep").textContent = (wtCurrent + 1) + " of " + walkthroughSteps.length;
      document.getElementById("wtNext").textContent = wtCurrent === walkthroughSteps.length - 1 ? "Done" : "Next";

      if (step.pos === "below") {
        box.style.top = (rect.bottom + 16) + "px";
        box.style.bottom = "auto";
      } else {
        box.style.top = "auto";
        box.style.bottom = (window.innerHeight - rect.top + 16) + "px";
      }
      box.style.left = Math.max(16, Math.min(rect.left, window.innerWidth - 360)) + "px";
    }

    function nextWalkthroughStep() {
      wtCurrent++;
      if (wtCurrent >= walkthroughSteps.length) { endWalkthrough(); return; }
      wtNavigateAndShow();
    }

    function endWalkthrough() {
      document.getElementById("walkthroughOverlay").classList.remove("active");
      showScreen("screenHome");
    }

    // ===== PLASMA COACH CHAT =====
    const COACH_API_URL = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
      ? "http://localhost:3001"
      : "https://plasmacoach.onrender.com";
    let chatMessages = [];
    let chatOpen = false;
    let coachKnowledgeLevel = "beginner";
    let coachFrustrationCount = 0;
    let coachSending = false;

    function showCoachFab() {
      document.getElementById("coachFab").classList.add("visible");
    }

    function toggleChat() {
      chatOpen = !chatOpen;
      const panel = document.getElementById("coachPanel");
      const fab = document.getElementById("coachFab");
      if (chatOpen) {
        panel.classList.add("open");
        fab.classList.remove("visible");
        document.getElementById("coachInput").focus();
      } else {
        panel.classList.remove("open");
        fab.classList.add("visible");
      }
    }

    function getPageContext() {
      const activeScreen = document.querySelector(".screen.active");
      if (!activeScreen) return null;
      const id = activeScreen.id;
      const map = {
        screenContacts: { pageName: "send-tokens", pageTitle: "Send Payment" },
        screenAmount: { pageName: "send-tokens", pageTitle: "Enter Amount" },
        screenPreview: { pageName: "send-tokens", pageTitle: "Confirm Payment" },
        screenHome: { pageName: "dashboard", pageTitle: "Dashboard" },
        screenFullHistory: { pageName: "transaction-history", pageTitle: "Transfer History" },
        screenRequests: { pageName: "receive-tokens", pageTitle: "Requests" },
        screenReceipt: { pageName: "send-tokens", pageTitle: "Payment Receipt" }
      };
      return map[id] || null;
    }

    function appendMessage(role, text) {
      const container = document.getElementById("coachMessages");
      const div = document.createElement("div");
      div.className = "coach-msg " + role;
      div.textContent = text;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function showTypingIndicator() {
      document.getElementById("coachTyping").classList.add("visible");
      const container = document.getElementById("coachMessages");
      container.scrollTop = container.scrollHeight;
    }

    function hideTypingIndicator() {
      document.getElementById("coachTyping").classList.remove("visible");
    }

    async function sendChatMessage() {
      const input = document.getElementById("coachInput");
      const text = input.value.trim();
      if (!text || coachSending) return;

      input.value = "";
      appendMessage("user", text);
      chatMessages.push({ role: "user", content: text });

      coachSending = true;
      document.getElementById("coachSendBtn").disabled = true;
      showTypingIndicator();

      try {
        const resp = await fetch(COACH_API_URL + "/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            messages: chatMessages,
            knowledgeLevel: coachKnowledgeLevel,
            frustrationCount: coachFrustrationCount,
            pageContext: getPageContext()
          })
        });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.error || "Request failed");
        }

        const data = await resp.json();
        hideTypingIndicator();

        appendMessage("assistant", data.reply);
        chatMessages.push({ role: "assistant", content: data.reply });

        if (data.knowledgeLevel) {
          coachKnowledgeLevel = data.knowledgeLevel;
          document.getElementById("coachLevel").value = coachKnowledgeLevel;
        }
        if (typeof data.frustrationCount === "number") {
          coachFrustrationCount = data.frustrationCount;
        }
        if (data.reachedLimit && data.contactMessage) {
          appendMessage("contact", data.contactMessage);
        }
      } catch (e) {
        hideTypingIndicator();
        appendMessage("assistant", "Sorry, I couldn't connect right now. Please try again in a moment.");
        console.error("Coach error:", e);
      }

      coachSending = false;
      document.getElementById("coachSendBtn").disabled = false;
    }

    // Show chat button after login
    const origShowTopbar = showTopbar;
    showTopbar = function() {
      origShowTopbar();
      showCoachFab();
    };
  </script>
</body>
</html>
