<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Plasma Pay</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg: #ffffff;
      --bg-light: #f5f5f3;
      --border: #e0e0dc;
      --text: #1a1a1a;
      --muted: #8a8a82;
      --green: #3d5a47;
      --green-light: #e8f0eb;
      --green-dark: #2f4636;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    .app { width: 100%; min-height: 100vh; position: relative; }

    /* ===== SCREENS ===== */
    .screen { display: none; flex-direction: column; min-height: calc(100vh - 65px); }
    .screen.active { display: flex; }
    .screen-pad { padding: 2rem 4rem; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ===== LOGIN SCREEN ===== */
    .login-screen {
      min-height: 100vh;
      background: var(--green);
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    .login-box { width: 100%; max-width: 420px; }
    .login-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 3rem;
    }
    .login-logo-icon {
      width: 48px; height: 48px;
      border: 3px solid rgba(255,255,255,0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .login-logo-icon-inner {
      width: 18px; height: 18px;
      background: rgba(255,255,255,0.6);
      border-radius: 50%;
    }
    .login-logo-text { font-size: 1.75rem; font-weight: 700; color: #fff; }
    .login-label { color: rgba(255,255,255,0.85); font-size: 0.9rem; font-weight: 500; margin-bottom: 0.5rem; }
    .login-input {
      width: 100%;
      padding: 0.9rem 1rem;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      color: #fff;
      font-size: 0.95rem;
      font-family: inherit;
      outline: none;
      margin-bottom: 1.25rem;
    }
    .login-input::placeholder { color: rgba(255,255,255,0.4); }
    .login-input:focus { border-color: rgba(255,255,255,0.5); }
    .login-btn {
      width: 100%;
      padding: 0.9rem;
      background: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      font-family: inherit;
      margin-top: 0.5rem;
      transition: opacity 0.15s;
    }
    .login-btn:hover { opacity: 0.9; }
    .login-footer { text-align: center; margin-top: 1.5rem; color: rgba(255,255,255,0.65); font-size: 0.9rem; }
    .login-footer a { color: #fff; text-decoration: underline; cursor: pointer; }

    /* ===== TOP BAR ===== */
    .topbar {
      display: flex;
      align-items: center;
      padding: 0.9rem 3rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .topbar-brand {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      cursor: pointer;
      flex-shrink: 0;
    }
    .topbar-logo-icon {
      width: 40px; height: 40px;
      border: 2.5px solid var(--green);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .topbar-logo-dot {
      width: 14px; height: 14px;
      background: var(--green);
      border-radius: 50%;
    }
    .topbar-brand-text { font-size: 1.3rem; font-weight: 700; color: var(--text); }
    .topbar-nav {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      margin-left: 2.5rem;
      flex: 1;
    }
    .topbar-nav button {
      background: none;
      border: none;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--muted);
      padding: 0.5rem 1.1rem;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .topbar-nav button:hover { color: var(--text); }
    .topbar-nav button.active {
      background: var(--green);
      color: #fff;
      font-weight: 600;
    }
    .topbar-profile {
      width: 40px; height: 40px;
      border-radius: 50%;
      background: var(--bg);
      border: 1.5px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      color: var(--muted);
    }
    .topbar-profile:hover { border-color: var(--green); color: var(--green); }

    /* ===== HOME ===== */
    .balance-hero {
      text-align: center;
      padding: 3rem 0 2.5rem;
    }
    .balance-label {
      color: var(--green);
      font-size: 0.95rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    .balance-amount {
      font-size: 3.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text);
    }
    .balance-currency {
      color: var(--muted);
      font-size: 0.95rem;
      margin-top: 0.25rem;
    }

    .home-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .home-section-header h2 { font-size: 1.2rem; font-weight: 700; }
    .view-all {
      color: var(--green);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: none;
      border: none;
      font-family: inherit;
    }
    .view-all:hover { text-decoration: underline; }

    /* Transaction items */
    .tx-card {
      border: 1.5px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      margin-bottom: 1.5rem;
    }
    .tx-item {
      display: flex;
      align-items: center;
      padding: 1rem 1.25rem;
    }
    .tx-item:not(:last-child) { border-bottom: 1px solid var(--border); }
    .tx-icon {
      width: 42px; height: 42px;
      border-radius: 50%;
      background: var(--green-light);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
      flex-shrink: 0;
      font-size: 1rem;
      color: var(--green);
    }
    .tx-info { flex: 1; }
    .tx-name { font-weight: 600; font-size: 0.95rem; }
    .tx-verified { color: var(--green); font-size: 0.8rem; font-weight: 500; display: flex; align-items: center; gap: 0.25rem; }
    .tx-amount { font-weight: 600; font-size: 0.95rem; text-align: right; }
    .tx-amount.outflow { color: var(--text); }
    .tx-amount.inflow { color: var(--green); }
    .tx-date-label {
      color: var(--green);
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.75rem;
      margin-top: 0.5rem;
    }

    /* Action cards */
    .action-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 2rem;
    }
    .action-card {
      background: var(--green-dark);
      border-radius: 16px;
      padding: 1.5rem;
      color: #fff;
      cursor: pointer;
      transition: transform 0.15s, opacity 0.15s;
      border: none;
      font-family: inherit;
      text-align: left;
    }
    .action-card:hover { transform: scale(1.02); opacity: 0.9; }
    .action-card-icon { font-size: 1.3rem; margin-bottom: 0.75rem; }
    .action-card-label { font-size: 1.05rem; font-weight: 600; }

    /* ===== PAYMENTS / REQUESTS ===== */
    .page-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; }
    .payees-card {
      border: 1.5px solid var(--border);
      border-radius: 14px;
      padding: 1.5rem;
    }
    .payees-label {
      color: var(--green);
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 1rem;
    }
    .payee-group-letter {
      color: var(--green);
      font-size: 0.85rem;
      font-weight: 600;
      padding: 0.5rem 0 0.25rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0.5rem;
    }
    .payee-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 0;
      cursor: pointer;
      transition: opacity 0.1s;
    }
    .payee-item:hover { opacity: 0.7; }
    .payee-avatar {
      width: 44px; height: 44px;
      border-radius: 50%;
      background: var(--green-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.85rem;
      color: #fff;
      margin-right: 1rem;
      flex-shrink: 0;
    }
    .payee-name { font-weight: 500; font-size: 1rem; }

    .fab {
      position: fixed;
      bottom: 2rem;
      right: 3rem;
      width: 56px; height: 56px;
      border-radius: 50%;
      background: var(--green-dark);
      color: #fff;
      border: none;
      font-size: 1.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      transition: transform 0.15s;
    }
    .fab:hover { transform: scale(1.08); }

    /* ===== AMOUNT ===== */
    .amount-display {
      text-align: center;
      padding: 2.5rem 0 1.5rem;
    }
    .amount-to { color: var(--muted); font-size: 0.95rem; margin-bottom: 0.75rem; }
    .amount-to span { color: var(--text); font-weight: 600; }
    .amount-value {
      font-size: 3.5rem; font-weight: 700; letter-spacing: -0.02em;
    }
    .amount-value .currency { color: var(--muted); }
    .numpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      max-width: 400px;
      margin: 1rem auto;
    }
    .numpad button {
      padding: 1rem;
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 1.3rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
    }
    .numpad button:active { background: var(--border); }

    /* ===== PREVIEW ===== */
    .preview-card {
      background: var(--bg-light);
      border: 1.5px solid var(--border);
      border-radius: 16px;
      padding: 2rem 1.5rem;
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .preview-avatars { display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1.25rem; }
    .preview-avatar {
      width: 48px; height: 48px; border-radius: 50%; background: var(--green-dark);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 1rem; color: #fff;
    }
    .preview-arrow { color: var(--muted); font-size: 1.25rem; }
    .preview-amount { font-size: 2.25rem; font-weight: 700; }
    .preview-desc { color: var(--muted); font-size: 0.9rem; }
    .preview-fee {
      display: inline-block; background: var(--green-light); color: var(--green);
      padding: 0.35rem 0.9rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; margin-top: 0.75rem;
    }
    .preview-details { margin-bottom: 1.5rem; }
    .preview-row { display: flex; justify-content: space-between; padding: 0.6rem 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
    .preview-row:last-child { border-bottom: none; }
    .preview-row .label { color: var(--muted); }

    /* ===== RECEIPT ===== */
    .receipt-screen { align-items: center; justify-content: center; text-align: center; }
    .receipt-check {
      width: 72px; height: 72px; background: var(--green); border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #fff;
      margin-bottom: 1.25rem;
      animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
    .receipt-amount { font-size: 2.25rem; font-weight: 700; margin-bottom: 0.15rem; }
    .receipt-desc { color: var(--muted); font-size: 0.95rem; margin-bottom: 2.5rem; }
    .receipt-buttons { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 0.5rem; }

    /* ===== BUTTONS ===== */
    .btn {
      width: 100%; padding: 0.9rem; border: none; border-radius: 10px;
      font-size: 0.95rem; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.15s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--green); color: #fff; }
    .btn-primary:hover { background: var(--green-dark); }
    .btn-outline { background: transparent; border: 1.5px solid var(--border); color: var(--text); }

    /* ===== ACCOUNT SIDEBAR ===== */
    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 200;
    }
    .sidebar-overlay.open { display: block; }
    .sidebar {
      position: fixed;
      top: 0; right: -380px;
      width: 380px;
      height: 100vh;
      background: var(--bg);
      z-index: 201;
      padding: 2rem;
      transition: right 0.3s ease;
      box-shadow: -4px 0 24px rgba(0,0,0,0.1);
    }
    .sidebar.open { right: 0; }
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .sidebar-header h2 { font-size: 1.3rem; font-weight: 700; }
    .sidebar-close {
      width: 36px; height: 36px;
      border-radius: 50%;
      background: var(--bg-light);
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
    }
    .sidebar-menu-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 0;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      font-family: inherit;
      text-align: left;
    }
    .sidebar-menu-item:hover { color: var(--green); }
    .sidebar-menu-icon {
      width: 24px;
      text-align: center;
      color: var(--muted);
      font-size: 1.1rem;
    }

    /* ===== BACK LINK ===== */
    .back-link {
      background: none; border: none; font-family: inherit;
      font-size: 0.95rem; color: var(--green); cursor: pointer; font-weight: 500; margin-right: 0.75rem;
    }
    .page-header { display: flex; align-items: center; margin-bottom: 1.5rem; }
    .page-header h2 { font-size: 1.25rem; font-weight: 700; }

    .spacer { flex: 1; }
    .empty-state { text-align: center; color: var(--muted); padding: 2rem 0; font-size: 0.9rem; }

    /* ===== REGISTER ===== */
    .register-screen {
      min-height: 100vh;
      background: var(--green);
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    .register-box { width: 100%; max-width: 420px; }
    .register-box h1 { color: #fff; font-size: 1.5rem; margin-bottom: 0.5rem; }
    .register-box .subtitle { color: rgba(255,255,255,0.65); font-size: 0.9rem; margin-bottom: 2rem; }

    /* ===== TOAST ===== */
    .toast {
      position: fixed;
      top: 1.5rem;
      left: 50%;
      transform: translateX(-50%) translateY(-120%);
      background: var(--text);
      color: #fff;
      padding: 0.85rem 1.5rem;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 500;
      z-index: 300;
      transition: transform 0.3s ease;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .toast.toast-error { background: #dc2626; }
    .toast.toast-success { background: var(--green); }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* ===== NAV BADGE ===== */
    .nav-badge-wrap { position: relative; display: inline-block; }
    .nav-badge {
      position: absolute;
      top: -6px; right: -8px;
      background: #dc2626;
      color: #fff;
      font-size: 0.65rem;
      font-weight: 700;
      min-width: 18px; height: 18px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- ===== LOGIN ===== -->
    <div id="screenConnect" class="screen login-screen active">
      <div class="login-box">
        <div class="login-logo">
          <div class="login-logo-icon"><div class="login-logo-icon-inner"></div></div>
          <div class="login-logo-text">Plasma</div>
        </div>
        <div>
          <div class="login-label">Email</div>
          <input class="login-input" type="text" placeholder="Enter your email" readonly>
          <div class="login-label">Password</div>
          <input class="login-input" type="password" placeholder="Enter your password" readonly>
          <button class="login-btn" id="connectBtn" onclick="connectWallet()">Log In</button>
          <div class="login-footer">Don't have an account? <a onclick="connectWallet()">Sign up</a></div>
        </div>
      </div>
    </div>

    <!-- ===== REGISTER ===== -->
    <div id="screenRegister" class="screen register-screen">
      <div class="register-box">
        <div class="login-logo">
          <div class="login-logo-icon"><div class="login-logo-icon-inner"></div></div>
          <div class="login-logo-text">Plasma</div>
        </div>
        <h1>What's your name?</h1>
        <p class="subtitle">This is how others will find you on Plasma Pay.</p>
        <div class="login-label">Display name</div>
        <input class="login-input" type="text" id="registerName" placeholder="e.g. Jaime" maxlength="20" onkeydown="if(event.key==='Enter')registerUser()">
        <button class="login-btn" onclick="registerUser()">Continue</button>
      </div>
    </div>

    <!-- ===== TOP BAR ===== -->
    <div id="topbar" class="topbar" style="display:none">
      <div class="topbar-brand" onclick="showHome()">
        <div class="topbar-logo-icon"><div class="topbar-logo-dot"></div></div>
        <span class="topbar-brand-text">Plasma</span>
      </div>
      <div class="topbar-nav">
        <button id="navPayments" onclick="showContacts()">Payments</button>
        <div class="nav-badge-wrap"><button id="navRequests" onclick="showRequests()">Requests</button><div class="nav-badge" id="requestBadge" style="display:none">0</div></div>
        <button id="navHistory" onclick="showFullHistory()">Transfer</button>
      </div>
      <div class="topbar-profile" onclick="openSidebar()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 21v-1a6 6 0 0 1 12 0v1"/></svg>
      </div>
    </div>

    <!-- ===== HOME ===== -->
    <div id="screenHome" class="screen">
      <div class="screen-pad">
        <div class="balance-hero">
          <div class="balance-label">Account Balance</div>
          <div class="balance-amount" id="homeBalance">$0.00</div>
          <div class="balance-currency">USDT</div>
        </div>

        <div id="homePendingSection" style="display:none;margin-bottom:2rem">
          <div class="home-section-header">
            <h2>Pending Requests</h2>
            <button class="view-all" onclick="showRequests()">View all</button>
          </div>
          <div id="homePendingList"></div>
        </div>

        <div class="home-section-header">
          <h2>Recent Transactions</h2>
          <button class="view-all" onclick="showFullHistory()">View all</button>
        </div>
        <div id="historyList"><div class="empty-state">No transactions yet</div></div>

        <div class="action-cards">
          <button class="action-card" onclick="showContacts()">
            <div class="action-card-icon">&#8599;</div>
            <div class="action-card-label">Send</div>
          </button>
          <button class="action-card" onclick="showRequests()">
            <div class="action-card-icon">&#8601;</div>
            <div class="action-card-label">Request</div>
          </button>
        </div>
      </div>
    </div>

    <!-- ===== PAYMENTS / CONTACTS ===== -->
    <div id="screenContacts" class="screen">
      <div class="screen-pad">
        <div class="page-title">Send Payment</div>
        <div class="payees-card">
          <div class="payees-label">Saved Payees</div>
          <div id="contactsList"></div>
        </div>
      </div>
    </div>

    <!-- ===== REQUESTS ===== -->
    <div id="screenRequests" class="screen">
      <div class="screen-pad">
        <div class="page-title">Requests</div>

        <div id="pendingRequestsSection" style="margin-bottom:2rem">
          <div class="home-section-header">
            <h2>Pending Requests</h2>
          </div>
          <div id="pendingRequestsList"><div class="empty-state">No pending requests</div></div>
        </div>

        <div id="outgoingRequestsSection" style="margin-bottom:2rem">
          <div class="home-section-header">
            <h2>Your Outgoing Requests</h2>
          </div>
          <div id="outgoingRequestsList"><div class="empty-state">No outgoing requests</div></div>
        </div>

        <div class="page-title" style="margin-top:1rem">New Request</div>
        <div class="payees-card">
          <div class="payees-label">Request From</div>
          <div id="requestContactsList"></div>
        </div>
      </div>
    </div>

    <!-- ===== AMOUNT ===== -->
    <div id="screenAmount" class="screen">
      <div class="screen-pad">
        <div class="page-header">
          <button class="back-link" onclick="flowMode==='send'?showContacts():showRequests()">&larr; Back</button>
        </div>
        <div class="amount-display">
          <div class="amount-to"><span id="amountToLabel">Sending to</span> <span id="amountToName">—</span></div>
          <div class="amount-value"><span class="currency">$</span><span id="amountDisplay">0</span></div>
        </div>
        <div class="numpad">
          <button onclick="numInput('1')">1</button>
          <button onclick="numInput('2')">2</button>
          <button onclick="numInput('3')">3</button>
          <button onclick="numInput('4')">4</button>
          <button onclick="numInput('5')">5</button>
          <button onclick="numInput('6')">6</button>
          <button onclick="numInput('7')">7</button>
          <button onclick="numInput('8')">8</button>
          <button onclick="numInput('9')">9</button>
          <button onclick="numInput('.')">.</button>
          <button onclick="numInput('0')">0</button>
          <button onclick="numDelete()">&#9003;</button>
        </div>
        <div style="max-width:400px;margin:0 auto">
          <button class="btn btn-primary" onclick="showPreview()">Next</button>
        </div>
      </div>
    </div>

    <!-- ===== PREVIEW ===== -->
    <div id="screenPreview" class="screen">
      <div class="screen-pad">
        <div class="page-header">
          <button class="back-link" onclick="showAmount()">&larr; Back</button>
        </div>
        <div class="preview-card">
          <div class="preview-avatars">
            <div class="preview-avatar" id="previewFromAvatar">J</div>
            <div class="preview-arrow">&rarr;</div>
            <div class="preview-avatar" id="previewToAvatar">N</div>
          </div>
          <div class="preview-amount" id="previewAmount">$10</div>
          <div class="preview-desc" id="previewDesc">will be sent to Nele</div>
          <div class="preview-fee">No fees</div>
        </div>
        <div class="preview-details">
          <div class="preview-row"><span class="label">From</span><span id="previewFrom">Jaime</span></div>
          <div class="preview-row"><span class="label">To</span><span id="previewTo">Nele</span></div>
          <div class="preview-row"><span class="label">Amount</span><span id="previewUSDT">$10.00</span></div>
          <div class="preview-row"><span class="label">Network fee</span><span style="color:var(--green)">$0.00</span></div>
        </div>
        <button class="btn btn-primary" id="confirmBtn" onclick="confirmPayment()">Confirm &amp; Send</button>
      </div>
    </div>

    <!-- ===== RECEIPT ===== -->
    <div id="screenReceipt" class="screen receipt-screen">
      <div class="receipt-check">&#10003;</div>
      <div class="receipt-amount" id="receiptAmount">$10</div>
      <div class="receipt-desc" id="receiptDesc">Sent to Nele</div>
      <div class="receipt-buttons">
        <button class="btn btn-primary" onclick="showContacts()">Send again</button>
        <button class="btn btn-outline" onclick="showHome()">Back to home</button>
      </div>
    </div>

    <!-- ===== FULL HISTORY ===== -->
    <div id="screenFullHistory" class="screen">
      <div class="screen-pad">
        <div class="balance-hero">
          <div class="balance-label">Account Balance</div>
          <div class="balance-amount" id="historyBalance">$0.00</div>
          <div class="balance-currency">USDT</div>
        </div>
        <div id="fullHistoryList"><div class="empty-state">No transactions yet</div></div>
      </div>
    </div>

    <!-- ===== ACCOUNT SIDEBAR ===== -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>Account</h2>
        <button class="sidebar-close" onclick="closeSidebar()">&times;</button>
      </div>
      <button class="sidebar-menu-item" onclick="closeSidebar()">
        <span class="sidebar-menu-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 21v-1a6 6 0 0 1 12 0v1"/></svg></span>
        Account Details
      </button>
      <button class="sidebar-menu-item">
        <span class="sidebar-menu-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></span>
        Settings
      </button>
      <button class="sidebar-menu-item">
        <span class="sidebar-menu-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg></span>
        Notifications
      </button>
      <button class="sidebar-menu-item">
        <span class="sidebar-menu-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></span>
        Privacy
      </button>
      <button class="sidebar-menu-item">
        <span class="sidebar-menu-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span>
        Help
      </button>
      <button class="sidebar-menu-item">
        <span class="sidebar-menu-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></span>
        Contact
      </button>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <script>
    function showToast(msg, type) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.className = "toast" + (type === "error" ? " toast-error" : type === "success" ? " toast-success" : "");
      requestAnimationFrame(() => { t.classList.add("show"); });
      setTimeout(() => { t.classList.remove("show"); }, 3500);
    }
    const CONTRACT_ADDRESS = "0xd9DEBe4f00fe7AbD7921CA0Dec92433495b8F0AF";
    const USDT_ADDRESS = "0x502012b361AebCE43b26Ec812B74D9a51dB4D412";
    const ABI = [
      "function register(string calldata name) external",
      "function sendByName(string calldata toName, uint256 amount) external",
      "function addressToName(address) view returns (string)",
      "function nameToAddress(string) view returns (address)",
      "function getContacts() view returns (string[] names, address[] addrs)",
      "function getMyHistory() view returns (tuple(address from, address to, string fromName, string toName, uint256 amount, uint256 timestamp)[])",
      "event UserRegistered(address indexed user, string name)",
      "event PaymentSent(address indexed from, address indexed to, string fromName, string toName, uint256 amount, uint256 timestamp)",
      "function requestByName(string calldata payerName, uint256 amount) external",
      "function fulfillRequest(uint256 requestId) external",
      "function getMyPendingRequests() view returns (tuple(uint256 id, address requester, address payer, string requesterName, string payerName, uint256 amount, uint256 timestamp, bool fulfilled, bool cancelled)[])",
      "function getMyOutgoingRequests() view returns (tuple(uint256 id, address requester, address payer, string requesterName, string payerName, uint256 amount, uint256 timestamp, bool fulfilled, bool cancelled)[])"
    ];
    const ERC20_ABI = [
      "function balanceOf(address) view returns (uint256)",
      "function decimals() view returns (uint8)",
      "function allowance(address owner, address spender) view returns (uint256)",
      "function approve(address spender, uint256 amount) returns (bool)"
    ];
    let usdtDecimals = 6;
    let provider, signer, contract, usdtContract, myAddress, myName;
    let selectedContact = { name: "", addr: "" };
    let amountStr = "0";
    let flowMode = "send"; // "send" or "request"

    function showScreen(id) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }
    function setActiveNav(btnId) {
      document.querySelectorAll(".topbar-nav button").forEach(b => b.classList.remove("active"));
      if (btnId) document.getElementById(btnId).classList.add("active");
    }
    function showTopbar() { document.getElementById("topbar").style.display = "flex"; }

    function openSidebar() {
      document.getElementById("sidebar").classList.add("open");
      document.getElementById("sidebarOverlay").classList.add("open");
    }
    function closeSidebar() {
      document.getElementById("sidebar").classList.remove("open");
      document.getElementById("sidebarOverlay").classList.remove("open");
    }

    async function connectWallet() {
      if (!window.ethereum) {
        showToast("Please install MetaMask and add Plasma Testnet (Chain ID 9746)", "error");
        return;
      }
      try {
        await window.ethereum.request({ method: "eth_requestAccounts" });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        const network = await provider.getNetwork();
        if (network.chainId !== 9746) {
          showToast("Please switch MetaMask to Plasma Testnet (Chain ID 9746)", "error");
          return;
        }
        signer = provider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        usdtContract = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);
        myAddress = await signer.getAddress();
        try { usdtDecimals = await usdtContract.decimals(); } catch(e) { usdtDecimals = 6; }
        myName = await contract.addressToName(myAddress);
        if (myName && myName.length > 0) {
          showTopbar();
          await showHome();
        } else {
          showScreen("screenRegister");
        }
      } catch (e) {
        console.error("Connect error:", e);
        showToast("Connection failed: " + (e.reason || e.message), "error");
      }
    }

    async function registerUser() {
      const name = document.getElementById("registerName").value.trim();
      if (!name) return;
      try {
        const tx = await contract.register(name);
        await tx.wait();
        myName = name;
        showTopbar();
        await showHome();
      } catch (e) { showToast("Registration failed: " + (e.reason || e.message), "error"); }
    }

    async function getUSDTBalance() {
      try {
        const decimals = await usdtContract.decimals();
        const bal = await usdtContract.balanceOf(myAddress);
        return parseFloat(ethers.utils.formatUnits(bal, decimals));
      } catch (e) { return 0; }
    }

    async function showHome() {
      setActiveNav(null);
      showScreen("screenHome");
      const usdt = await getUSDTBalance();
      document.getElementById("homeBalance").textContent = "$" + usdt.toFixed(2);
      await refreshPendingRequests();
      await loadHistory("historyList", 4);
    }

    async function refreshPendingRequests() {
      try {
        const reqs = await contract.getMyPendingRequests();
        const badge = document.getElementById("requestBadge");
        const section = document.getElementById("homePendingSection");
        const list = document.getElementById("homePendingList");
        if (reqs.length === 0) {
          badge.style.display = "none";
          section.style.display = "none";
          return;
        }
        badge.textContent = reqs.length;
        badge.style.display = "flex";
        section.style.display = "block";
        let html = '<div class="tx-card">';
        for (const r of reqs) {
          const amt = parseFloat(ethers.utils.formatUnits(r.amount, usdtDecimals)).toFixed(2);
          html += `
            <div class="tx-item">
              <div class="tx-icon" style="background:#fef2f2;color:#dc2626">&#8601;</div>
              <div class="tx-info">
                <div class="tx-name">${r.requesterName} requested $${amt}</div>
                <div class="tx-verified" style="color:var(--muted)">Tap Pay to accept</div>
              </div>
              <button class="btn btn-primary" style="width:auto;padding:0.5rem 1rem;font-size:0.85rem" onclick="fulfillRequest(${r.id})">Pay</button>
            </div>`;
        }
        html += '</div>';
        list.innerHTML = html;
      } catch (e) { console.error("Pending refresh error:", e); }
    }

    async function loadHistory(elementId, limit) {
      try {
        const history = await contract.getMyHistory();
        const listEl = document.getElementById(elementId);
        if (history.length === 0) {
          listEl.innerHTML = '<div class="empty-state">No transactions yet</div>';
          return;
        }
        listEl.innerHTML = "";
        const count = limit ? Math.min(limit, history.length) : history.length;
        let currentLabel = "";
        let cardHtml = "";
        let items = [];

        for (let i = history.length - 1; i >= history.length - count; i--) {
          const p = history[i];
          const isSender = p.from.toLowerCase() === myAddress.toLowerCase();
          const name = isSender ? p.toName : p.fromName;
          const usdAmt = parseFloat(ethers.utils.formatUnits(p.amount, usdtDecimals)).toFixed(2);
          const date = new Date(p.timestamp.toNumber() * 1000);
          const now = new Date();
          let label = date.toLocaleDateString([], { day: "numeric", month: "short" });
          const diffDays = Math.floor((now - date) / 86400000);
          if (diffDays === 0) label = "TODAY";
          else if (diffDays === 1) label = "YESTERDAY";
          else if (diffDays < 7) label = "THIS WEEK";

          items.push({ name, isSender, usdAmt, label, date });
        }

        let html = "";
        let lastLabel = "";
        let inCard = false;
        for (const item of items) {
          if (item.label !== lastLabel) {
            if (inCard) html += '</div>';
            html += `<div class="tx-date-label">${item.label}</div><div class="tx-card">`;
            inCard = true;
            lastLabel = item.label;
          }
          const arrow = item.isSender ? "&#8599;" : "&#8601;";
          html += `
            <div class="tx-item">
              <div class="tx-icon">${arrow}</div>
              <div class="tx-info">
                <div class="tx-name">${item.name}</div>
                <div class="tx-verified"><svg width="12" height="12" viewBox="0 0 24 24" fill="var(--green)" stroke="none"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg> Verified</div>
              </div>
              <div class="tx-amount ${item.isSender ? "outflow" : "inflow"}">${item.isSender ? "-" : "+"}$${item.usdAmt}</div>
            </div>`;
        }
        if (inCard) html += '</div>';
        listEl.innerHTML = html;
      } catch (e) { console.error("History error:", e); }
    }

    async function loadContactsList(elementId, onClickFn) {
      const listEl = document.getElementById(elementId);
      listEl.innerHTML = '<div class="empty-state">Loading...</div>';
      try {
        const [names, addrs] = await contract.getContacts();
        let contacts = [];
        for (let i = 0; i < names.length; i++) {
          if (addrs[i].toLowerCase() === myAddress.toLowerCase()) continue;
          contacts.push({ name: names[i], addr: addrs[i] });
        }
        contacts.sort((a, b) => a.name.localeCompare(b.name));
        if (contacts.length === 0) { listEl.innerHTML = '<div class="empty-state">No contacts found</div>'; return; }

        let html = "";
        let lastLetter = "";
        for (const c of contacts) {
          const letter = c.name.charAt(0).toUpperCase();
          if (letter !== lastLetter) {
            html += `<div class="payee-group-letter">${letter}</div>`;
            lastLetter = letter;
          }
          const initials = c.name.substring(0, 2).toUpperCase();
          html += `
            <div class="payee-item" onclick="${onClickFn}('${c.name}', '${c.addr}')">
              <div class="payee-avatar">${initials}</div>
              <div class="payee-name">${c.name}</div>
            </div>`;
        }
        listEl.innerHTML = html;
      } catch (e) { listEl.innerHTML = '<div class="empty-state">Error loading contacts</div>'; }
    }

    async function showContacts() {
      setActiveNav("navPayments");
      showScreen("screenContacts");
      await loadContactsList("contactsList", "selectContact");
    }

    async function showRequests() {
      setActiveNav("navRequests");
      showScreen("screenRequests");
      await loadPendingRequests();
      await loadOutgoingRequests();
      await loadContactsList("requestContactsList", "selectRequestContact");
    }

    function selectContact(name, addr) {
      flowMode = "send";
      selectedContact = { name, addr };
      amountStr = "0";
      document.getElementById("amountDisplay").textContent = "0";
      document.getElementById("amountToName").textContent = name;
      document.getElementById("amountToLabel").textContent = "Sending to";
      showScreen("screenAmount");
    }

    function selectRequestContact(name, addr) {
      flowMode = "request";
      selectedContact = { name, addr };
      amountStr = "0";
      document.getElementById("amountDisplay").textContent = "0";
      document.getElementById("amountToName").textContent = name;
      document.getElementById("amountToLabel").textContent = "Requesting from";
      showScreen("screenAmount");
    }

    function numInput(ch) {
      if (amountStr === "0" && ch !== ".") amountStr = ch;
      else if (ch === "." && amountStr.includes(".")) return;
      else if (amountStr.includes(".") && amountStr.split(".")[1].length >= 2) return;
      else amountStr += ch;
      document.getElementById("amountDisplay").textContent = amountStr;
    }
    function numDelete() {
      amountStr = amountStr.slice(0, -1) || "0";
      document.getElementById("amountDisplay").textContent = amountStr;
    }
    function showAmount() { showScreen("screenAmount"); }

    function showPreview() {
      const usd = parseFloat(amountStr);
      if (!usd || usd <= 0) return;
      if (flowMode === "send") {
        document.getElementById("previewFromAvatar").textContent = myName.substring(0, 2).toUpperCase();
        document.getElementById("previewToAvatar").textContent = selectedContact.name.substring(0, 2).toUpperCase();
        document.getElementById("previewDesc").textContent = "will be sent to " + selectedContact.name;
        document.getElementById("previewFrom").textContent = myName;
        document.getElementById("previewTo").textContent = selectedContact.name;
        document.getElementById("confirmBtn").textContent = "Confirm & Send";
      } else {
        document.getElementById("previewFromAvatar").textContent = selectedContact.name.substring(0, 2).toUpperCase();
        document.getElementById("previewToAvatar").textContent = myName.substring(0, 2).toUpperCase();
        document.getElementById("previewDesc").textContent = "will be requested from " + selectedContact.name;
        document.getElementById("previewFrom").textContent = selectedContact.name;
        document.getElementById("previewTo").textContent = myName;
        document.getElementById("confirmBtn").textContent = "Send Request";
      }
      document.getElementById("previewAmount").textContent = "$" + amountStr;
      document.getElementById("previewUSDT").textContent = "$" + parseFloat(amountStr).toFixed(2);
      showScreen("screenPreview");
    }

    async function confirmPayment() {
      const usd = parseFloat(amountStr);
      const usdtAmount = ethers.utils.parseUnits(usd.toFixed(usdtDecimals), usdtDecimals);
      const btn = document.getElementById("confirmBtn");
      try {
        if (flowMode === "send") {
          btn.textContent = "Approving..."; btn.disabled = true;
          const allowance = await usdtContract.allowance(myAddress, CONTRACT_ADDRESS);
          if (allowance.lt(usdtAmount)) {
            const approveTx = await usdtContract.approve(CONTRACT_ADDRESS, ethers.constants.MaxUint256);
            await approveTx.wait();
          }
          btn.textContent = "Sending...";
          const tx = await contract.sendByName(selectedContact.name, usdtAmount);
          await tx.wait();
          document.getElementById("receiptAmount").textContent = "$" + amountStr;
          document.getElementById("receiptDesc").textContent = "Sent to " + selectedContact.name;
          getUSDTBalance().then(usdt => {
            document.getElementById("homeBalance").textContent = "$" + usdt.toFixed(2);
          });
        } else {
          btn.textContent = "Requesting..."; btn.disabled = true;
          const tx = await contract.requestByName(selectedContact.name, usdtAmount);
          await tx.wait();
          document.getElementById("receiptAmount").textContent = "$" + amountStr;
          document.getElementById("receiptDesc").textContent = "Requested from " + selectedContact.name;
        }
        btn.textContent = "Confirm & Send"; btn.disabled = false;
        showScreen("screenReceipt");
      } catch (e) {
        btn.textContent = flowMode === "send" ? "Confirm & Send" : "Send Request";
        btn.disabled = false;
        showToast("Failed: " + (e.reason || e.message), "error");
      }
    }

    async function loadPendingRequests() {
      const el = document.getElementById("pendingRequestsList");
      try {
        const reqs = await contract.getMyPendingRequests();
        if (reqs.length === 0) { el.innerHTML = '<div class="empty-state">No pending requests</div>'; return; }
        let html = '<div class="tx-card">';
        for (const r of reqs) {
          const amt = parseFloat(ethers.utils.formatUnits(r.amount, usdtDecimals)).toFixed(2);
          html += `
            <div class="tx-item">
              <div class="tx-icon">&#8601;</div>
              <div class="tx-info">
                <div class="tx-name">${r.requesterName} requested $${amt}</div>
                <div class="tx-verified" style="color:var(--muted)">Tap Pay to send</div>
              </div>
              <button class="btn btn-primary" style="width:auto;padding:0.5rem 1rem;font-size:0.85rem" onclick="fulfillRequest(${r.id})">Pay</button>
            </div>`;
        }
        html += '</div>';
        el.innerHTML = html;
      } catch (e) { el.innerHTML = '<div class="empty-state">Error loading requests</div>'; }
    }

    async function loadOutgoingRequests() {
      const el = document.getElementById("outgoingRequestsList");
      try {
        const reqs = await contract.getMyOutgoingRequests();
        if (reqs.length === 0) { el.innerHTML = '<div class="empty-state">No outgoing requests</div>'; return; }
        let html = '<div class="tx-card">';
        for (const r of reqs) {
          const amt = parseFloat(ethers.utils.formatUnits(r.amount, usdtDecimals)).toFixed(2);
          html += `
            <div class="tx-item">
              <div class="tx-icon">&#8987;</div>
              <div class="tx-info">
                <div class="tx-name">$${amt} from ${r.payerName}</div>
                <div class="tx-verified" style="color:var(--muted)">Waiting for payment</div>
              </div>
              <div class="tx-amount" style="color:var(--muted)">Pending</div>
            </div>`;
        }
        html += '</div>';
        el.innerHTML = html;
      } catch (e) { el.innerHTML = '<div class="empty-state">Error loading requests</div>'; }
    }

    async function fulfillRequest(requestId) {
      // Save details before transaction so we have them for the receipt
      let reqName = "";
      let reqAmt = "";
      try {
        const reqs = await contract.getMyPendingRequests();
        const req = reqs.find(r => r.id.toNumber() === requestId);
        if (!req) { showToast("Request not found", "error"); return; }
        reqName = req.requesterName;
        reqAmt = parseFloat(ethers.utils.formatUnits(req.amount, usdtDecimals)).toFixed(2);

        const allowance = await usdtContract.allowance(myAddress, CONTRACT_ADDRESS);
        if (allowance.lt(req.amount)) {
          const approveTx = await usdtContract.approve(CONTRACT_ADDRESS, ethers.constants.MaxUint256);
          await approveTx.wait();
        }
        const tx = await contract.fulfillRequest(requestId);
        await tx.wait();
      } catch (e) {
        showToast("Payment failed: " + (e.reason || e.message), "error");
        return;
      }
      // Transaction succeeded — show receipt
      document.getElementById("receiptAmount").textContent = "$" + reqAmt;
      document.getElementById("receiptDesc").textContent = "Sent to " + reqName;
      showScreen("screenReceipt");
      getUSDTBalance().then(usdt => {
        document.getElementById("homeBalance").textContent = "$" + usdt.toFixed(2);
      }).catch(() => {});
    }

    async function showFullHistory() {
      setActiveNav("navHistory");
      showScreen("screenFullHistory");
      const usdt = await getUSDTBalance();
      document.getElementById("historyBalance").textContent = "$" + usdt.toFixed(2);
      await loadHistory("fullHistoryList", null);
    }

    // Poll for new pending requests every 15 seconds
    setInterval(async () => {
      if (contract && myAddress) {
        await refreshPendingRequests();
      }
    }, 15000);

    if (window.ethereum) {
      window.ethereum.on("accountsChanged", () => location.reload());
      window.ethereum.on("chainChanged", () => location.reload());
    }
    window.addEventListener("load", function() {
      const btn = document.getElementById("connectBtn");
      if (typeof ethers === "undefined") { btn.textContent = "ERROR: ethers.js failed to load"; btn.style.background = "#dc2626"; btn.style.color = "#fff"; return; }
      if (!window.ethereum) { btn.textContent = "MetaMask not detected"; btn.style.background = "#dc2626"; btn.style.color = "#fff"; return; }
    });
  </script>
</body>
</html>
